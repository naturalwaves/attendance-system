{% extends "base.html" %}

{% block title %}Edit Query Template{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-warning bg-gradient text-dark">
                <div class="card-body py-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-1"><i class="fas fa-edit me-2"></i>Edit Query Template</h4>
                            <p class="mb-0 opacity-75">Modify your email template</p>
                        </div>
                        <a href="{{ url_for('query_templates') }}" class="btn btn-dark">
                            <i class="fas fa-arrow-left me-1"></i> Back to Templates
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <form method="POST" action="{{ url_for('edit_query_template', id=template.id) }}">
                <!-- Template Info Card -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-light py-3">
                        <h6 class="mb-0"><i class="fas fa-info-circle text-primary me-2"></i>Template Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Organization</label>
                                <input type="text" class="form-control bg-light" value="{{ template.organization.name }}" disabled>
                            </div>
                            <div class="col-md-6">
                                <label for="from_email" class="form-label">Reply-To Email</label>
                                <input type="email" class="form-control" id="from_email" name="from_email" value="{{ template.from_email or '' }}" placeholder="hr@organization.com">
                                <small class="text-muted">Replies from staff will go to this email</small>
                            </div>
                            <div class="col-md-6">
                                <label for="title" class="form-label">Template Title <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" name="title" value="{{ template.title }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="subject" class="form-label">Email Subject <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="subject" name="subject" value="{{ template.subject }}" required>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Placeholders Card -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-light py-3">
                        <h6 class="mb-0"><i class="fas fa-code text-info me-2"></i>Available Placeholders</h6>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">Click any placeholder to insert it into the email body</p>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm placeholder-btn" data-placeholder="{staff_name}">
                                <i class="fas fa-user me-1"></i>{staff_name}
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm placeholder-btn" data-placeholder="{staff_id}">
                                <i class="fas fa-id-badge me-1"></i>{staff_id}
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm placeholder-btn" data-placeholder="{department}">
                                <i class="fas fa-building me-1"></i>{department}
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm placeholder-btn" data-placeholder="{branch}">
                                <i class="fas fa-code-branch me-1"></i>{branch}
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm placeholder-btn" data-placeholder="{late_count}">
                                <i class="fas fa-clock me-1"></i>{late_count}
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm placeholder-btn" data-placeholder="{period}">
                                <i class="fas fa-calendar-alt me-1"></i>{period}
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm placeholder-btn" data-placeholder="{current_date}">
                                <i class="fas fa-calendar-day me-1"></i>{current_date}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Email Body Card -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-light py-3">
                        <h6 class="mb-0"><i class="fas fa-envelope-open-text text-success me-2"></i>Email Body <span class="text-danger">*</span></h6>
                    </div>
                    <div class="card-body p-0">
                        <div id="editor-container"></div>
                        <input type="hidden" id="body" name="body">
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('query_templates') }}" class="btn btn-outline-secondary px-4">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-warning px-4">
                        <i class="fas fa-save me-2"></i>Update Template
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

<style>
    #editor-container {
        height: 400px;
        background: white;
        border: none;
    }
    
    #editor-container .ql-editor {
        font-size: 14px;
        line-height: 1.6;
    }
    
    .ql-toolbar.ql-snow {
        border: none;
        border-bottom: 1px solid #e9ecef;
        background: #f8f9fa;
        padding: 12px;
    }
    
    .ql-container.ql-snow {
        border: none;
    }
    
    .placeholder-btn {
        transition: all 0.2s ease;
    }
    
    .placeholder-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    /* Font family styles */
    .ql-font-candara { font-family: 'Candara', sans-serif; }
    .ql-font-gabriola { font-family: 'Gabriola', cursive; }
    .ql-font-cambria { font-family: 'Cambria', serif; }
    .ql-font-calibri { font-family: 'Calibri', sans-serif; }
    .ql-font-arial { font-family: 'Arial', sans-serif; }
    .ql-font-times-new-roman { font-family: 'Times New Roman', serif; }
    .ql-font-georgia { font-family: 'Georgia', serif; }
    .ql-font-verdana { font-family: 'Verdana', sans-serif; }
    .ql-font-tahoma { font-family: 'Tahoma', sans-serif; }

    /* Font picker labels */
    .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="candara"]::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="candara"]::before { content: 'Candara'; font-family: 'Candara', sans-serif; }
    .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="gabriola"]::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="gabriola"]::before { content: 'Gabriola'; font-family: 'Gabriola', cursive; }
    .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="cambria"]::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="cambria"]::before { content: 'Cambria'; font-family: 'Cambria', serif; }
    .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="calibri"]::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="calibri"]::before { content: 'Calibri'; font-family: 'Calibri', sans-serif; }
    .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="arial"]::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="arial"]::before { content: 'Arial'; font-family: 'Arial', sans-serif; }
    .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="times-new-roman"]::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="times-new-roman"]::before { content: 'Times New Roman'; font-family: 'Times New Roman', serif; }
    .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="georgia"]::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="georgia"]::before { content: 'Georgia'; font-family: 'Georgia', serif; }
    .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="verdana"]::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="verdana"]::before { content: 'Verdana'; font-family: 'Verdana', sans-serif; }
    .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="tahoma"]::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="tahoma"]::before { content: 'Tahoma'; font-family: 'Tahoma', sans-serif; }

    /* Font size picker - Numbers */
    .ql-snow .ql-picker.ql-size .ql-picker-label::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item::before { content: '14'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="8px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="8px"]::before { content: '8'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="9px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="9px"]::before { content: '9'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="10px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="10px"]::before { content: '10'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="11px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="11px"]::before { content: '11'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="12px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="12px"]::before { content: '12'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="13px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="13px"]::before { content: '13'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="14px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="14px"]::before { content: '14'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="15px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="15px"]::before { content: '15'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="16px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="16px"]::before { content: '16'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="18px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="18px"]::before { content: '18'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="20px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="20px"]::before { content: '20'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="22px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="22px"]::before { content: '22'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="24px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="24px"]::before { content: '24'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="26px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="26px"]::before { content: '26'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="28px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="28px"]::before { content: '28'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="32px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="32px"]::before { content: '32'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="36px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="36px"]::before { content: '36'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="40px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="40px"]::before { content: '40'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="48px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="48px"]::before { content: '48'; }
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="72px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="72px"]::before { content: '72'; }

    /* Size classes */
    .ql-size-8px { font-size: 8px; }
    .ql-size-9px { font-size: 9px; }
    .ql-size-10px { font-size: 10px; }
    .ql-size-11px { font-size: 11px; }
    .ql-size-12px { font-size: 12px; }
    .ql-size-13px { font-size: 13px; }
    .ql-size-14px { font-size: 14px; }
    .ql-size-15px { font-size: 15px; }
    .ql-size-16px { font-size: 16px; }
    .ql-size-18px { font-size: 18px; }
    .ql-size-20px { font-size: 20px; }
    .ql-size-22px { font-size: 22px; }
    .ql-size-24px { font-size: 24px; }
    .ql-size-26px { font-size: 26px; }
    .ql-size-28px { font-size: 28px; }
    .ql-size-32px { font-size: 32px; }
    .ql-size-36px { font-size: 36px; }
    .ql-size-40px { font-size: 40px; }
    .ql-size-48px { font-size: 48px; }
    .ql-size-72px { font-size: 72px; }
</style>

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
    // Register custom fonts
    var Font = Quill.import('formats/font');
    Font.whitelist = ['candara', 'gabriola', 'cambria', 'calibri', 'arial', 'times-new-roman', 'georgia', 'verdana', 'tahoma'];
    Quill.register(Font, true);

    // Register custom sizes (numbers)
    var Size = Quill.import('attributors/style/size');
    Size.whitelist = ['8px', '9px', '10px', '11px', '12px', '13px', '14px', '15px', '16px', '18px', '20px', '22px', '24px', '26px', '28px', '32px', '36px', '40px', '48px', '72px'];
    Quill.register(Size, true);

    // Initialize Quill
    var quill = new Quill('#editor-container', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'font': Font.whitelist }],
                [{ 'size': Size.whitelist }],
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'align': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'indent': '-1'}, { 'indent': '+1' }],
                ['link'],
                ['clean']
            ]
        },
        placeholder: 'Compose your email template here...'
    });

    // Load existing content
    quill.root.innerHTML = `{{ template.body | safe }}`;

    // Save content to hidden field on form submit
    document.querySelector('form').addEventListener('submit', function() {
        document.getElementById('body').value = quill.root.innerHTML;
    });

    // Placeholder button click handler
    document.querySelectorAll('.placeholder-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var placeholder = this.getAttribute('data-placeholder');
            var range = quill.getSelection(true);
            quill.insertText(range.index, placeholder);
            quill.setSelection(range.index + placeholder.length);
        });
    });
</script>
{% endblock %}
