{% extends 'base.html' %}

{% block title %}Edit Query Template - Attendance System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-lg" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);">
            <div class="card-body py-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div>
                        <h3 class="mb-1 fw-bold text-white">
                            <i class="fas fa-edit me-2"></i>Edit Query Template
                        </h3>
                        <p class="mb-0 text-white-50"><i class="fas fa-info-circle me-1"></i> Modify your email template for staff queries</p>
                    </div>
                    <a href="{{ url_for('query_templates') }}" class="btn btn-light btn-sm">
                        <i class="fas fa-arrow-left me-1"></i> Back to Templates
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template Info Card -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white py-3">
        <h6 class="mb-0 fw-semibold">
            <i class="fas fa-info-circle me-2 text-primary"></i>Template Information
        </h6>
    </div>
    <div class="card-body">
        <form method="POST" id="templateForm">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label small fw-semibold">Organization</label>
                    <div class="form-control bg-light">
                        {% if template.organization %}
                        <i class="fas fa-sitemap me-2 text-info"></i>{{ template.organization.name }}
                        {% else %}
                        <span class="text-muted">N/A</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="col-md-4">
                    <label class="form-label small fw-semibold">Template Title <span class="text-danger">*</span></label>
                    <input type="text" name="title" class="form-control" value="{{ template.title }}" required>
                </div>
                
                <div class="col-md-4">
                    <label class="form-label small fw-semibold">Email Subject <span class="text-danger">*</span></label>
                    <input type="text" name="subject" class="form-control" value="{{ template.subject }}" required>
                </div>
            </div>
            <div class="mt-2">
                <small class="text-muted"><i class="fas fa-lightbulb me-1"></i> Subject placeholders: <code>{staff_name}</code>, <code>{date}</code></small>
            </div>
    </div>
</div>

<!-- Email Body Card - Full Width -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white py-3">
        <h6 class="mb-0 fw-semibold">
            <i class="fas fa-envelope me-2 text-primary"></i>Email Body <span class="text-danger">*</span>
        </h6>
    </div>
    <div class="card-body">
        <textarea name="body" id="editor">{{ template.body }}</textarea>
    </div>
    <div class="card-footer bg-light">
        <small class="text-muted">
            <i class="fas fa-lightbulb me-1"></i> Available placeholders: 
            <code>{staff_name}</code>, 
            <code>{times_late}</code>, 
            <code>{date}</code>, 
            <code>{organization_name}</code>, 
            <code>{branch_name}</code>
        </small>
    </div>
</div>

<!-- Action Buttons -->
<div class="card border-0 shadow-sm">
    <div class="card-body">
        <div class="d-flex gap-2">
            <button type="submit" form="templateForm" class="btn btn-primary btn-lg">
                <i class="fas fa-save me-2"></i>Update Template
            </button>
            <a href="{{ url_for('query_templates') }}" class="btn btn-outline-secondary btn-lg">Cancel</a>
        </div>
    </div>
</div>
</form>

<!-- CKEditor 5 -->
<script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/super-build/ckeditor.js"></script>

<script>
CKEDITOR.ClassicEditor.create(document.getElementById("editor"), {
    toolbar: {
        items: [
            'heading', '|',
            'fontFamily', 'fontSize', 'fontColor', 'fontBackgroundColor', '|',
            'bold', 'italic', 'underline', 'strikethrough', '|',
            'alignment', '|',
            'bulletedList', 'numberedList', 'outdent', 'indent', '|',
            'link', 'insertTable', 'horizontalLine', '|',
            'undo', 'redo'
        ],
        shouldNotGroupWhenFull: true
    },
    fontFamily: {
        options: [
            'default',
            'Arial, Helvetica, sans-serif',
            'Calibri, sans-serif',
            'Cambria, serif',
            'Candara, sans-serif',
            'Century Gothic, sans-serif',
            'Comic Sans MS, cursive',
            'Consolas, monospace',
            'Constantia, serif',
            'Corbel, sans-serif',
            'Courier New, Courier, monospace',
            'Georgia, serif',
            'Lucida Console, monospace',
            'Lucida Sans Unicode, sans-serif',
            'Palatino Linotype, serif',
            'Segoe UI, sans-serif',
            'Tahoma, Geneva, sans-serif',
            'Times New Roman, Times, serif',
            'Trebuchet MS, Helvetica, sans-serif',
            'Verdana, Geneva, sans-serif'
        ],
        supportAllValues: true
    },
    fontSize: {
        options: [8, 9, 10, 11, 12, 14, 16, 18, 20, 22, 24, 26, 28, 32, 36, 48, 72],
        supportAllValues: true
    },
    placeholder: 'Compose your query email here...',
    htmlSupport: {
        allow: [
            { name: /.*/, attributes: true, classes: true, styles: true }
        ]
    },
    removePlugins: ['MediaEmbed', 'MediaEmbedToolbar']
}).then(editor => {
    window.editor = editor;
    
    // Set minimum height
    editor.editing.view.change(writer => {
        writer.setStyle('min-height', '500px', editor.editing.view.document.getRoot());
    });
    
    // Sync content to textarea on form submit
    document.getElementById('templateForm').addEventListener('submit', function() {
        document.getElementById('editor').value = editor.getData();
    });
}).catch(error => {
    console.error(error);
});
</script>

<style>
.ck-editor__editable {
    min-height: 500px !important;
    font-size: 14px;
    line-height: 1.6;
}

.ck.ck-editor {
    border-radius: 8px;
    overflow: hidden;
}

.ck.ck-toolbar {
    background-color: #f8f9fc !important;
    border-bottom: 1px solid #dee2e6 !important;
    padding: 8px !important;
}

.ck.ck-editor__main > .ck-editor__editable {
    background-color: #fff;
    padding: 20px;
}

.text-white-50 {
    color: rgba(255, 255, 255, 0.7) !important;
}

.card {
    border-radius: 0.75rem;
}

code {
    background-color: #e9ecef;
    padding: 2px 6px;
    border-radius: 4px;
    color: #d63384;
}
</style>
{% endblock %}
