{% extends "base.html" %}

{% block title %}Staff List - Attendance System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1">
                            <i class="fas fa-users text-primary me-2"></i>Staff List
                            {% if selected_branch and branches %}
                                {% for branch in branches %}
                                    {% if branch.id == selected_branch %}
                                        <span class="text-muted">- {{ branch.name }}</span>
                                    {% endif %}
                                {% endfor %}
                            {% elif selected_organization and organizations %}
                                {% for org in organizations %}
                                    {% if org.id == selected_organization %}
                                        <span class="text-muted">- {{ org.name }}</span>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </h4>
                        <p class="text-muted mb-0">Manage staff members and their information</p>
                    </div>
                    {% if current_user.role in ['super_admin', 'school_admin'] %}
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('export_staff_csv') }}" class="btn btn-outline-success">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </a>
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                            <i class="fas fa-upload me-1"></i> Bulk Upload
                        </button>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStaffModal">
                            <i class="fas fa-plus me-1"></i> Add Staff
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm bg-primary bg-gradient text-white">
            <div class="card-body text-center py-3">
                <div class="display-6 fw-bold">{{ staff|length }}</div>
                <div class="small opacity-75">Total Staff</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm bg-success bg-gradient text-white">
            <div class="card-body text-center py-3">
                <div class="display-6 fw-bold">{{ staff|selectattr('is_active')|list|length }}</div>
                <div class="small opacity-75">Active</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm bg-secondary bg-gradient text-white">
            <div class="card-body text-center py-3">
                <div class="display-6 fw-bold">{{ staff|rejectattr('is_active')|list|length }}</div>
                <div class="small opacity-75">Inactive</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm bg-info bg-gradient text-white">
            <div class="card-body text-center py-3">
                <div class="display-6 fw-bold">
                    {% if selected_branch %}
                        1
                    {% elif selected_organization %}
                        {{ branches|length }}
                    {% else %}
                        {{ schools|length }}
                    {% endif %}
                </div>
                <div class="small opacity-75">Branches</div>
            </div>
        </div>
    </div>
</div>

<!-- Filters Card -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white py-3">
        <h6 class="mb-0"><i class="fas fa-filter text-muted me-2"></i>Filters</h6>
    </div>
    <div class="card-body">
        <form method="GET" id="filterForm">
            <div class="row g-3">
                {% if current_user.role == 'super_admin' %}
                <div class="col-md-4">
                    <label class="form-label small text-muted">Organization</label>
                    <select name="organization_id" id="organizationFilter" class="form-select" onchange="updateBranches()">
                        <option value="">All Organizations</option>
                        {% for org in organizations %}
                        <option value="{{ org.id }}" {% if selected_organization == org.id %}selected{% endif %}>{{ org.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <div class="col-md-4">
                    <label class="form-label small text-muted">Branch</label>
                    <select name="branch_id" id="branchFilter" class="form-select" onchange="this.form.submit()">
                        <option value="">All Branches</option>
                        {% for branch in branches %}
                        <option value="{{ branch.id }}" {% if selected_branch == branch.id %}selected{% endif %}>{{ branch.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <a href="{{ url_for('staff_list') }}" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-redo me-1"></i> Reset Filters
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Search Box -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body py-2">
        <div class="input-group">
            <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
            <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Search by name, ID, or department..." onkeyup="searchStaff()">
        </div>
    </div>
</div>

<!-- Staff Table -->
<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="staffTable">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-3">Staff ID</th>
                        <th>Name</th>
                        <th>Branch</th>
                        <th>Department</th>
                        <th>Contact</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in staff %}
                    <tr>
                        <td class="ps-3">
                            <span class="badge bg-light text-dark">{{ s.staff_id }}</span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-circle me-2">
                                    {{ s.name[0] | upper }}
                                </div>
                                <div>
                                    <div class="fw-semibold">{{ s.name }}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{ s.school.short_name or s.school.name if s.school else 'N/A' }}</td>
                        <td>{{ s.department }}</td>
                        <td>
                            <div class="small">
                                {% if s.email %}<i class="fas fa-envelope text-muted me-1"></i>{{ s.email }}<br>{% endif %}
                                {% if s.phone %}<i class="fas fa-phone text-muted me-1"></i>{{ s.phone }}{% endif %}
                                {% if not s.email and not s.phone %}<span class="text-muted">No contact</span>{% endif %}
                            </div>
                        </td>
                        <td class="text-center">
                            {% if s.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if current_user.role in ['super_admin', 'school_admin'] %}
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary" onclick="editStaff({{ s.id }}, '{{ s.staff_id }}', '{{ s.name }}', '{{ s.school_id }}', '{{ s.department }}', '{{ s.email or '' }}', '{{ s.phone or '' }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <form action="{{ url_for('toggle_staff', id=s.id) }}" method="POST" class="d-inline">
                                    <button type="submit" class="btn btn-outline-{{ 'warning' if s.is_active else 'success' }}" title="{{ 'Deactivate' if s.is_active else 'Activate' }}">
                                        <i class="fas fa-{{ 'toggle-on' if s.is_active else 'toggle-off' }}"></i>
                                    </button>
                                </form>
                                <form action="{{ url_for('delete_staff', id=s.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this staff member?')">
                                    <button type="submit" class="btn btn-outline-danger">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% if staff|length == 0 %}
    <div class="card-body text-center py-5">
        <i class="fas fa-users fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No Staff Found</h5>
        <p class="text-muted mb-0">Try adjusting your filters or add new staff members.</p>
    </div>
    {% endif %}
</div>

<style>
.avatar-circle {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.9rem;
}
.display-6 {
    font-size: 1.75rem;
}
</style>

<!-- Add Staff Modal -->
<div class="modal fade" id="addStaffModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Add Staff</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('add_staff') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Staff ID</label>
                        <input type="text" name="staff_id" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Branch</label>
                        <select name="school_id" class="form-select" required>
                            <option value="">Select Branch</option>
                            {% for school in schools %}
                            <option value="{{ school.id }}">{{ school.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Department</label>
                        <input type="text" name="department" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" name="phone" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Staff</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Staff Modal -->
<div class="modal fade" id="editStaffModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-edit me-2"></i>Edit Staff</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editStaffForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Staff ID</label>
                        <input type="text" name="staff_id" id="editStaffId" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" name="name" id="editName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Branch</label>
                        <select name="school_id" id="editSchoolId" class="form-select" required>
                            <option value="">Select Branch</option>
                            {% for school in schools %}
                            <option value="{{ school.id }}">{{ school.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Department</label>
                        <input type="text" name="department" id="editDepartment" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" id="editEmail" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" name="phone" id="editPhone" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-upload me-2"></i>Bulk Upload Staff</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('bulk_upload') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <p class="text-muted small">Upload a CSV file with columns: staff_id, name, school_id, department, email, phone</p>
                    <div class="mb-3">
                        <input type="file" name="file" class="form-control" accept=".csv" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function searchStaff() {
    const input = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#staffTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(input) ? '' : 'none';
    });
}

function editStaff(id, staffId, name, schoolId, department, email, phone) {
    document.getElementById('editStaffForm').action = '/staff/edit/' + id;
    document.getElementById('editStaffId').value = staffId;
    document.getElementById('editName').value = name;
    document.getElementById('editSchoolId').value = schoolId;
    document.getElementById('editDepartment').value = department;
    document.getElementById('editEmail').value = email;
    document.getElementById('editPhone').value = phone;
    
    new bootstrap.Modal(document.getElementById('editStaffModal')).show();
}

function updateBranches() {
    const orgId = document.getElementById('organizationFilter').value;
    const branchSelect = document.getElementById('branchFilter');
    
    branchSelect.value = '';
    document.getElementById('filterForm').submit();
}
</script>
{% endblock %}
