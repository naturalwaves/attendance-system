{% extends 'base.html' %}

{% block title %}Staff List - Attendance System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Staff List</h2>
    <div>
        {% if current_user.role == 'super_admin' or current_user.role == 'school_admin' %}
        <a href="{{ url_for('bulk_upload') }}" class="btn btn-outline-primary me-2">
            <i class="fas fa-upload me-2"></i>Bulk Upload
        </a>
        <a href="{{ url_for('add_staff') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Add Staff
        </a>
        {% endif %}
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            {% if current_user.role == 'super_admin' %}
            <div class="col-md-4">
                <label class="form-label">Filter by Organization</label>
                <select id="organizationFilter" class="form-select" onchange="filterByOrganization()">
                    <option value="">All Organizations</option>
                    {% for org in organizations %}
                    <option value="{{ org.id }}" {% if selected_organization == org.id %}selected{% endif %}>{{ org.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="col-md-4">
                <label class="form-label">Search Staff</label>
                <input type="text" id="searchInput" class="form-control" placeholder="Search by name or ID..." onkeyup="searchStaff()">
            </div>
            <div class="col-md-4">
                <span class="text-muted" id="staffCount">Showing {{ staff|length }} staff</span>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="staffTable">
                <thead>
                    <tr>
                        <th>Staff ID</th>
                        <th>Name</th>
                        <th>Branch</th>
                        <th>Department</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in staff %}
                    <tr data-name="{{ s.name|lower }}" data-id="{{ s.staff_id|lower }}" data-org="{{ s.school.organization_id }}">
                        <td>{{ s.staff_id }}</td>
                        <td>{{ s.name }}</td>
                        <td>{{ s.school.name }}</td>
                        <td>{{ s.department or '-' }}</td>
                        <td>
                            {% if s.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editStaff({{ s.id }}, '{{ s.staff_id }}', '{{ s.name }}', '{{ s.department }}', {{ s.school_id }}, {{ s.school.organization_id }}, {{ s.is_active|lower }})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <a href="{{ url_for('toggle_staff', id=s.id) }}" class="btn btn-sm btn-outline-warning me-1" title="{% if s.is_active %}Deactivate{% else %}Activate{% endif %}">
                                <i class="fas fa-{% if s.is_active %}ban{% else %}check{% endif %}"></i>
                            </a>
                            <a href="{{ url_for('delete_staff', id=s.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this staff?')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Staff</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Staff ID</label>
                        <input type="text" name="staff_id" id="editStaffId" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" id="editName" class="form-control" required>
                    </div>
                    {% if current_user.role == 'super_admin' %}
                    <div class="mb-3">
                        <label class="form-label">Organization</label>
                        <select id="editOrganization" class="form-select" onchange="loadBranchesForEdit()" required>
                            <option value="">Select Organization...</option>
                            {% for org in organizations %}
                            <option value="{{ org.id }}">{{ org.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        <label class="form-label">Branch</label>
                        <select name="school_id" id="editSchool" class="form-select" onchange="loadDepartmentsForEdit()" required>
                            <option value="">Select Branch...</option>
                            {% for school in schools %}
                            <option value="{{ school.id }}" data-org="{{ school.organization_id }}">{{ school.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Select {% if current_user.role == 'super_admin' %}organization then {% endif %}branch to load departments</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Department</label>
                        <select name="department" id="editDepartment" class="form-select" required>
                            <option value="">Select department...</option>
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" name="is_active" id="editActive" class="form-check-input">
                        <label class="form-check-label" for="editActive">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Store all branches for filtering
const allBranches = [
    {% for school in schools %}
    { id: {{ school.id }}, name: "{{ school.name }}", org_id: {{ school.organization_id }} },
    {% endfor %}
];

function filterByOrganization() {
    const orgId = document.getElementById('organizationFilter').value;
    const currentUrl = new URL(window.location.href);
    
    if (orgId) {
        currentUrl.searchParams.set('organization_id', orgId);
    } else {
        currentUrl.searchParams.delete('organization_id');
    }
    
    window.location.href = currentUrl.toString();
}

function searchStaff() {
    const input = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#staffTable tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const name = row.getAttribute('data-name');
        const id = row.getAttribute('data-id');
        
        if (name.includes(input) || id.includes(input)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    document.getElementById('staffCount').textContent = `Showing ${visibleCount} staff`;
}

function editStaff(id, staffId, name, department, schoolId, orgId, isActive) {
    document.getElementById('editForm').action = `/staff/edit/${id}`;
    document.getElementById('editStaffId').value = staffId;
    document.getElementById('editName').value = name;
    document.getElementById('editActive').checked = isActive;
    
    {% if current_user.role == 'super_admin' %}
    // Set organization first
    const orgSelect = document.getElementById('editOrganization');
    orgSelect.value = orgId;
    
    // Filter branches by organization
    loadBranchesForEdit(schoolId);
    {% else %}
    document.getElementById('editSchool').value = schoolId;
    loadDepartmentsForEdit(department);
    {% endif %}
    
    new bootstrap.Modal(document.getElementById('editModal')).show();
}

{% if current_user.role == 'super_admin' %}
function loadBranchesForEdit(preselectedBranchId = null) {
    const orgId = document.getElementById('editOrganization').value;
    const branchSelect = document.getElementById('editSchool');
    const deptSelect = document.getElementById('editDepartment');
    
    // Clear current options
    branchSelect.innerHTML = '<option value="">Select Branch...</option>';
    deptSelect.innerHTML = '<option value="">Select department...</option>';
    
    if (!orgId) return;
    
    // Filter branches by organization
    const filteredBranches = allBranches.filter(b => b.org_id == orgId);
    
    filteredBranches.forEach(branch => {
        const option = document.createElement('option');
        option.value = branch.id;
        option.textContent = branch.name;
        option.setAttribute('data-org', branch.org_id);
        branchSelect.appendChild(option);
    });
    
    // Preselect branch if provided
    if (preselectedBranchId) {
        branchSelect.value = preselectedBranchId;
        loadDepartmentsForEdit();
    }
}
{% endif %}

function loadDepartmentsForEdit(preselectedDept = null) {
    const branchId = document.getElementById('editSchool').value;
    const deptSelect = document.getElementById('editDepartment');
    
    if (!branchId) {
        deptSelect.innerHTML = '<option value="">Select department...</option>';
        return;
    }
    
    fetch(`/api/branch-departments/${branchId}`)
        .then(response => response.json())
        .then(departments => {
            deptSelect.innerHTML = '<option value="">Select department...</option>';
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.name;
                option.textContent = dept.name;
                deptSelect.appendChild(option);
            });
            
            // Preselect department if provided
            if (preselectedDept) {
                deptSelect.value = preselectedDept;
            }
        });
}

// For edit modal - need to capture the department to preselect
let currentEditDepartment = '';

function editStaff(id, staffId, name, department, schoolId, orgId, isActive) {
    document.getElementById('editForm').action = `/staff/edit/${id}`;
    document.getElementById('editStaffId').value = staffId;
    document.getElementById('editName').value = name;
    document.getElementById('editActive').checked = isActive;
    currentEditDepartment = department;
    
    {% if current_user.role == 'super_admin' %}
    const orgSelect = document.getElementById('editOrganization');
    orgSelect.value = orgId;
    loadBranchesForEditWithDept(schoolId, department);
    {% else %}
    document.getElementById('editSchool').value = schoolId;
    loadDepartmentsForEditWithDept(department);
    {% endif %}
    
    new bootstrap.Modal(document.getElementById('editModal')).show();
}

{% if current_user.role == 'super_admin' %}
function loadBranchesForEditWithDept(preselectedBranchId, department) {
    const orgId = document.getElementById('editOrganization').value;
    const branchSelect = document.getElementById('editSchool');
    const deptSelect = document.getElementById('editDepartment');
    
    branchSelect.innerHTML = '<option value="">Select Branch...</option>';
    deptSelect.innerHTML = '<option value="">Select department...</option>';
    
    if (!orgId) return;
    
    const filteredBranches = allBranches.filter(b => b.org_id == orgId);
    
    filteredBranches.forEach(branch => {
        const option = document.createElement('option');
        option.value = branch.id;
        option.textContent = branch.name;
        option.setAttribute('data-org', branch.org_id);
        branchSelect.appendChild(option);
    });
    
    if (preselectedBranchId) {
        branchSelect.value = preselectedBranchId;
        loadDepartmentsForEditWithDept(department);
    }
}
{% endif %}

function loadDepartmentsForEditWithDept(department) {
    const branchId = document.getElementById('editSchool').value;
    const deptSelect = document.getElementById('editDepartment');
    
    if (!branchId) {
        deptSelect.innerHTML = '<option value="">Select department...</option>';
        return;
    }
    
    fetch(`/api/branch-departments/${branchId}`)
        .then(response => response.json())
        .then(departments => {
            deptSelect.innerHTML = '<option value="">Select department...</option>';
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.name;
                option.textContent = dept.name;
                deptSelect.appendChild(option);
            });
            
            if (department) {
                deptSelect.value = department;
            }
        });
}
</script>
{% endblock %}
