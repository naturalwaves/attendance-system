{% extends 'base.html' %}

{% block title %}Staff List - Attendance System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Staff List</h2>
    <div>
        {% if current_user.role == 'super_admin' or current_user.role == 'school_admin' %}
        <a href="{{ url_for('download_staff_csv') }}" class="btn btn-outline-success me-2">
            <i class="fas fa-file-csv me-2"></i>Export CSV
        </a>
        <a href="{{ url_for('bulk_upload') }}" class="btn btn-outline-primary me-2">
            <i class="fas fa-upload me-2"></i>Bulk Upload
        </a>
        <a href="{{ url_for('add_staff') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Add Staff
        </a>
        {% endif %}
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" id="filterForm">
            <div class="row g-3 align-items-end">
                {% if current_user.role == 'super_admin' %}
                <div class="col-md-3">
                    <label class="form-label">Organization</label>
                    <select name="organization_id" id="organizationFilter" class="form-select" onchange="filterByOrganization()">
                        <option value="">All Organizations</option>
                        {% for org in organizations %}
                        <option value="{{ org.id }}" {% if selected_organization == org.id %}selected{% endif %}>{{ org.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <div class="col-md-3">
                    <label class="form-label">Branch</label>
                    <select name="branch_id" id="branchFilter" class="form-select" onchange="this.form.submit()">
                        <option value="">All Branches</option>
                        {% for branch in branches %}
                        <option value="{{ branch.id }}" {% if selected_branch == branch.id %}selected{% endif %}>{{ branch.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Search Staff</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by name or ID..." onkeyup="searchStaff()">
                </div>
                <div class="col-md-3 d-flex justify-content-between align-items-center">
                    <span class="text-muted" id="staffCount">Showing {{ staff|length }} staff</span>
                    <a href="{{ url_for('staff_list') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-redo me-1"></i> Reset
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="staffTable">
                <thead>
                    <tr>
                        <th>Staff ID</th>
                        <th>Name</th>
                        <th>Branch</th>
                        <th>Department</th>
                        <th>Contact</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in staff %}
                    <tr data-name="{{ s.name|lower }}" data-id="{{ s.staff_id|lower }}" data-org="{{ s.school.organization_id }}">
                        <td>{{ s.staff_id }}</td>
                        <td>
                            {% if s.photo_url %}
                            <img src="{{ s.photo_url }}" alt="{{ s.name }}" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;">
                            {% endif %}
                            {{ s.name }}
                        </td>
                        <td>{{ s.school.name }}</td>
                        <td>{{ s.department or '-' }}</td>
                        <td>
                            {% if s.email %}
                            <small class="text-muted d-block">{{ s.email }}</small>
                            {% else %}
                            <span class="badge bg-warning text-dark" title="No email on file"><i class="fas fa-exclamation-triangle"></i> No Email</span>
                            {% endif %}
                            {% if s.phone %}
                            <small class="text-muted d-block">{{ s.phone }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if s.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editStaff({{ s.id }}, '{{ s.staff_id }}', '{{ s.name }}', '{{ s.department }}', {{ s.school_id }}, {{ s.school.organization_id }}, {{ s.is_active|lower }}, '{{ s.email or '' }}', '{{ s.phone or '' }}', '{{ s.photo_url or '' }}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <a href="{{ url_for('toggle_staff', id=s.id) }}" class="btn btn-sm btn-outline-warning me-1" title="{% if s.is_active %}Deactivate{% else %}Activate{% endif %}">
                                <i class="fas fa-{% if s.is_active %}ban{% else %}check{% endif %}"></i>
                            </a>
                            <a href="{{ url_for('delete_staff', id=s.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this staff?')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Staff</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editForm" method="POST">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Staff ID <span class="text-danger">*</span></label>
                            <input type="text" name="staff_id" id="editStaffId" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" name="name" id="editName" class="form-control" required>
                        </div>
                    </div>
                    
                    {% if current_user.role == 'super_admin' %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Organization <span class="text-danger">*</span></label>
                            <select id="editOrganization" class="form-select" onchange="loadBranchesForEdit()" required>
                                <option value="">Select Organization...</option>
                                {% for org in organizations %}
                                <option value="{{ org.id }}">{{ org.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Branch <span class="text-danger">*</span></label>
                            <select name="school_id" id="editSchool" class="form-select" onchange="loadDepartmentsForEdit()" required>
                                <option value="">Select Branch...</option>
                                {% for school in schools %}
                                <option value="{{ school.id }}" data-org="{{ school.organization_id }}">{{ school.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% else %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Branch <span class="text-danger">*</span></label>
                            <select name="school_id" id="editSchool" class="form-select" onchange="loadDepartmentsForEdit()" required>
                                <option value="">Select Branch...</option>
                                {% for school in schools %}
                                <option value="{{ school.id }}" data-org="{{ school.organization_id }}">{{ school.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Department <span class="text-danger">*</span></label>
                            <select name="department" id="editDepartment" class="form-select" required>
                                <option value="">Select department...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3 d-flex align-items-end">
                            <div class="form-check">
                                <input type="checkbox" name="is_active" id="editActive" class="form-check-input">
                                <label class="form-check-label" for="editActive">Active</label>
                            </div>
                        </div>
                    </div>

                    <hr class="my-3">
                    <h6 class="mb-3">Contact Information (Optional)</h6>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" id="editEmail" class="form-control" placeholder="e.g. staff@company.com">
                            <small class="text-muted">Used for sending query emails</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" name="phone" id="editPhone" class="form-control" placeholder="e.g. 08012345678">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Photo URL</label>
                            <input type="url" name="photo_url" id="editPhotoUrl" class="form-control" placeholder="e.g. https://example.com/photo.jpg">
                            <small class="text-muted">Paste a link to the staff member's photo</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Store all branches for filtering
const allBranches = [
    {% for school in schools %}
    { id: {{ school.id }}, name: "{{ school.name }}", org_id: {{ school.organization_id }} },
    {% endfor %}
];

function filterByOrganization() {
    const orgId = document.getElementById('organizationFilter').value;
    const branchSelect = document.getElementById('branchFilter');
    const currentUrl = new URL(window.location.href);
    
    // Update branch dropdown based on selected organization
    branchSelect.innerHTML = '<option value="">All Branches</option>';
    
    if (orgId) {
        const filteredBranches = allBranches.filter(b => b.org_id == orgId);
        filteredBranches.forEach(branch => {
            const option = document.createElement('option');
            option.value = branch.id;
            option.textContent = branch.name;
            branchSelect.appendChild(option);
        });
        currentUrl.searchParams.set('organization_id', orgId);
    } else {
        allBranches.forEach(branch => {
            const option = document.createElement('option');
            option.value = branch.id;
            option.textContent = branch.name;
            branchSelect.appendChild(option);
        });
        currentUrl.searchParams.delete('organization_id');
    }
    
    currentUrl.searchParams.delete('branch_id');
    window.location.href = currentUrl.toString();
}

function searchStaff() {
    const input = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#staffTable tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const name = row.getAttribute('data-name');
        const id = row.getAttribute('data-id');
        
        if (name.includes(input) || id.includes(input)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    document.getElementById('staffCount').textContent = `Showing ${visibleCount} staff`;
}

function editStaff(id, staffId, name, department, schoolId, orgId, isActive, email, phone, photoUrl) {
    document.getElementById('editForm').action = `/staff/edit/${id}`;
    document.getElementById('editStaffId').value = staffId;
    document.getElementById('editName').value = name;
    document.getElementById('editActive').checked = isActive;
    document.getElementById('editEmail').value = email;
    document.getElementById('editPhone').value = phone;
    document.getElementById('editPhotoUrl').value = photoUrl;
    
    {% if current_user.role == 'super_admin' %}
    const orgSelect = document.getElementById('editOrganization');
    orgSelect.value = orgId;
    loadBranchesForEditWithDept(schoolId, department);
    {% else %}
    document.getElementById('editSchool').value = schoolId;
    loadDepartmentsForEditWithDept(department);
    {% endif %}
    
    new bootstrap.Modal(document.getElementById('editModal')).show();
}

{% if current_user.role == 'super_admin' %}
function loadBranchesForEdit() {
    const orgId = document.getElementById('editOrganization').value;
    const branchSelect = document.getElementById('editSchool');
    const deptSelect = document.getElementById('editDepartment');
    
    branchSelect.innerHTML = '<option value="">Select Branch...</option>';
    deptSelect.innerHTML = '<option value="">Select department...</option>';
    
    if (!orgId) return;
    
    const filteredBranches = allBranches.filter(b => b.org_id == orgId);
    
    filteredBranches.forEach(branch => {
        const option = document.createElement('option');
        option.value = branch.id;
        option.textContent = branch.name;
        option.setAttribute('data-org', branch.org_id);
        branchSelect.appendChild(option);
    });
}

function loadBranchesForEditWithDept(preselectedBranchId, department) {
    const orgId = document.getElementById('editOrganization').value;
    const branchSelect = document.getElementById('editSchool');
    const deptSelect = document.getElementById('editDepartment');
    
    branchSelect.innerHTML = '<option value="">Select Branch...</option>';
    deptSelect.innerHTML = '<option value="">Select department...</option>';
    
    if (!orgId) return;
    
    const filteredBranches = allBranches.filter(b => b.org_id == orgId);
    
    filteredBranches.forEach(branch => {
        const option = document.createElement('option');
        option.value = branch.id;
        option.textContent = branch.name;
        option.setAttribute('data-org', branch.org_id);
        branchSelect.appendChild(option);
    });
    
    if (preselectedBranchId) {
        branchSelect.value = preselectedBranchId;
        loadDepartmentsForEditWithDept(department);
    }
}
{% endif %}

function loadDepartmentsForEdit() {
    const branchId = document.getElementById('editSchool').value;
    const deptSelect = document.getElementById('editDepartment');
    
    if (!branchId) {
        deptSelect.innerHTML = '<option value="">Select department...</option>';
        return;
    }
    
    fetch(`/api/branch-departments/${branchId}`)
        .then(response => response.json())
        .then(departments => {
            deptSelect.innerHTML = '<option value="">Select department...</option>';
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.name;
                option.textContent = dept.name;
                deptSelect.appendChild(option);
            });
        });
}

function loadDepartmentsForEditWithDept(department) {
    const branchId = document.getElementById('editSchool').value;
    const deptSelect = document.getElementById('editDepartment');
    
    if (!branchId) {
        deptSelect.innerHTML = '<option value="">Select department...</option>';
        return;
    }
    
    fetch(`/api/branch-departments/${branchId}`)
        .then(response => response.json())
        .then(departments => {
            deptSelect.innerHTML = '<option value="">Select department...</option>';
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.name;
                option.textContent = dept.name;
                deptSelect.appendChild(option);
            });
            
            if (department) {
                deptSelect.value = department;
            }
        });
}
</script>
{% endblock %}
