{% extends "base.html" %}

{% block title %}Analytics - Attendance System{% endblock %}

{% block content %}
<style>
    /* Metric Cards - Rich but Professional */
    .metric-card {
        border: none;
        border-radius: 16px;
        overflow: hidden;
        transition: all 0.3s ease;
        position: relative;
    }
    .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 30px rgba(0,0,0,0.15) !important;
    }
    .metric-card .card-body {
        padding: 1.5rem;
        position: relative;
        z-index: 2;
    }
    
    /* Soft gradient backgrounds */
    .metric-card.soft-red {
        background: linear-gradient(145deg, #fff 0%, #fff5f5 50%, #ffe8e8 100%);
        border: 1px solid rgba(220, 53, 69, 0.15);
    }
    .metric-card.soft-green {
        background: linear-gradient(145deg, #fff 0%, #f0fff4 50%, #dcffe4 100%);
        border: 1px solid rgba(40, 167, 69, 0.15);
    }
    .metric-card.soft-blue {
        background: linear-gradient(145deg, #fff 0%, #f0f7ff 50%, #e0efff 100%);
        border: 1px solid rgba(0, 123, 255, 0.15);
    }
    .metric-card.soft-purple {
        background: linear-gradient(145deg, #fff 0%, #f8f5ff 50%, #efe8ff 100%);
        border: 1px solid rgba(111, 66, 193, 0.15);
    }
    .metric-card.soft-teal {
        background: linear-gradient(145deg, #fff 0%, #f0fdff 50%, #d9f7fa 100%);
        border: 1px solid rgba(23, 162, 184, 0.15);
    }
    .metric-card.soft-orange {
        background: linear-gradient(145deg, #fff 0%, #fff9f0 50%, #fff0db 100%);
        border: 1px solid rgba(253, 126, 20, 0.15);
    }
    .metric-card.soft-pink {
        background: linear-gradient(145deg, #fff 0%, #fff5f9 50%, #ffe8f1 100%);
        border: 1px solid rgba(232, 62, 140, 0.15);
    }
    .metric-card.soft-dark {
        background: linear-gradient(145deg, #fff 0%, #f8f9fa 50%, #eef0f2 100%);
        border: 1px solid rgba(52, 58, 64, 0.15);
    }
    
    .metric-card .bg-shape {
        position: absolute;
        right: -20px;
        bottom: -20px;
        width: 120px;
        height: 120px;
        border-radius: 50%;
        opacity: 0.08;
        z-index: 1;
    }
    .metric-card.soft-red .bg-shape { background: #dc3545; }
    .metric-card.soft-green .bg-shape { background: #28a745; }
    .metric-card.soft-blue .bg-shape { background: #007bff; }
    .metric-card.soft-purple .bg-shape { background: #6f42c1; }
    .metric-card.soft-teal .bg-shape { background: #17a2b8; }
    .metric-card.soft-orange .bg-shape { background: #fd7e14; }
    .metric-card.soft-pink .bg-shape { background: #e83e8c; }
    .metric-card.soft-dark .bg-shape { background: #343a40; }
    
    .metric-card .metric-icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        color: #fff;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .metric-card.soft-red .metric-icon { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
    .metric-card.soft-green .metric-icon { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); }
    .metric-card.soft-blue .metric-icon { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); }
    .metric-card.soft-purple .metric-icon { background: linear-gradient(135deg, #6f42c1 0%, #59359a 100%); }
    .metric-card.soft-teal .metric-icon { background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%); }
    .metric-card.soft-orange .metric-icon { background: linear-gradient(135deg, #fd7e14 0%, #e06b0a 100%); }
    .metric-card.soft-pink .metric-icon { background: linear-gradient(135deg, #e83e8c 0%, #d31a72 100%); }
    .metric-card.soft-dark .metric-icon { background: linear-gradient(135deg, #495057 0%, #343a40 100%); }
    
    .metric-card .metric-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        color: #6c757d;
        font-weight: 600;
        margin-bottom: 0.35rem;
    }
    .metric-card .metric-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1.2;
        margin-bottom: 0.25rem;
    }
    .metric-card.soft-red .metric-value { color: #c82333; }
    .metric-card.soft-green .metric-value { color: #1e7e34; }
    .metric-card.soft-blue .metric-value { color: #0056b3; }
    .metric-card.soft-purple .metric-value { color: #59359a; }
    .metric-card.soft-teal .metric-value { color: #117a8b; }
    .metric-card.soft-orange .metric-value { color: #e06b0a; }
    .metric-card.soft-pink .metric-value { color: #d31a72; }
    .metric-card.soft-dark .metric-value { color: #343a40; }
    
    .metric-card .metric-trend {
        font-size: 0.8rem;
        font-weight: 600;
        padding: 3px 10px;
        border-radius: 20px;
        display: inline-flex;
        align-items: center;
    }
    .metric-trend.up {
        background: rgba(40, 167, 69, 0.15);
        color: #1e7e34;
    }
    .metric-trend.down {
        background: rgba(220, 53, 69, 0.15);
        color: #c82333;
    }
    .metric-card .metric-subtitle {
        font-size: 0.8rem;
        color: #6c757d;
        font-weight: 500;
    }

    /* Chart Cards */
    .chart-card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        background: #fff;
        overflow: hidden;
    }
    .chart-card .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
        border-bottom: 1px solid #eee;
        padding: 1.15rem 1.5rem;
    }
    .chart-card .card-header h5 {
        font-weight: 600;
        font-size: 0.95rem;
        margin: 0;
        color: #333;
    }
    .chart-card .card-header .header-icon {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-size: 1rem;
        color: #fff;
    }
    .chart-card .card-body {
        padding: 1.5rem;
    }

    /* Ranking Cards */
    .ranking-card {
        border: none;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        background: #fff;
    }
    .ranking-card .card-header {
        padding: 1.15rem 1.5rem;
        border: none;
        position: relative;
        overflow: hidden;
    }
    .ranking-card .card-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100%;
        background: rgba(255,255,255,0.1);
        transform: skewX(-20deg);
    }
    .ranking-card .card-header h5 {
        font-weight: 600;
        font-size: 0.95rem;
        margin: 0;
        position: relative;
        z-index: 1;
    }
    .ranking-card .table {
        margin: 0;
    }
    .ranking-card .table th {
        border-top: none;
        font-weight: 600;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        padding: 0.9rem 1.25rem;
        background: #fafbfc;
    }
    .ranking-card .table td {
        padding: 0.9rem 1.25rem;
        vertical-align: middle;
        border-color: #f3f3f3;
        font-size: 0.875rem;
    }
    .ranking-card .table tbody tr {
        transition: background 0.2s ease;
    }
    .ranking-card .table tbody tr:hover {
        background: #f8f9fa;
    }
    .ranking-card .empty-state {
        padding: 2.5rem 1rem;
    }
    .ranking-card .empty-state i {
        font-size: 2.5rem;
        opacity: 0.2;
        margin-bottom: 0.75rem;
    }

    /* Rank Badges */
    .rank-badge {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.75rem;
    }
    .rank-gold { 
        background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%); 
        color: #664d00;
        box-shadow: 0 3px 10px rgba(255, 184, 0, 0.4);
    }
    .rank-silver { 
        background: linear-gradient(135deg, #e8e8e8 0%, #c0c0c0 100%); 
        color: #555;
        box-shadow: 0 3px 10px rgba(192, 192, 192, 0.4);
    }
    .rank-bronze { 
        background: linear-gradient(135deg, #cd7f32 0%, #b8722c 100%); 
        color: #fff;
        box-shadow: 0 3px 10px rgba(205, 127, 50, 0.4);
    }
    .rank-default {
        background: #f1f3f4;
        color: #5f6368;
    }

    /* Filter Card */
    .filter-card {
        border: none;
        border-radius: 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    }
    .filter-card .card-body {
        padding: 1.25rem 1.5rem;
    }
    .filter-card .form-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: rgba(255,255,255,0.85);
        font-weight: 600;
        margin-bottom: 0.4rem;
    }
    .filter-card .form-select,
    .filter-card .form-control {
        background: rgba(255,255,255,0.95);
        border: none;
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
    }
    .filter-card .form-select:focus,
    .filter-card .form-control:focus {
        box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
    }
    .filter-card .btn-filter {
        background: #fff;
        color: #667eea;
        border: none;
        font-weight: 600;
        padding: 0.5rem 1rem;
        transition: all 0.2s ease;
    }
    .filter-card .btn-filter:hover {
        background: #f8f9fa;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* Branch/Stat Badge */
    .branch-badge {
        background: linear-gradient(135deg, #f1f3f4 0%, #e8eaed 100%);
        color: #5f6368;
        font-weight: 500;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.75rem;
    }

    /* Score Badges */
    .score-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.8rem;
    }
    .score-badge.success {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
    }
    .score-badge.danger {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        color: #721c24;
    }
    .score-badge.info {
        background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        color: #0c5460;
    }
    .score-badge.purple {
        background: linear-gradient(135deg, #e2d9f3 0%, #d4c4ed 100%);
        color: #4a2c82;
    }
    .score-badge.orange {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: #8a4500;
    }

    /* Trend Badges */
    .trend-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.75rem;
        display: inline-flex;
        align-items: center;
    }
    .trend-badge.up {
        background: rgba(40, 167, 69, 0.15);
        color: #1e7e34;
    }
    .trend-badge.down {
        background: rgba(220, 53, 69, 0.15);
        color: #c82333;
    }
    .trend-badge.neutral {
        background: rgba(108, 117, 125, 0.15);
        color: #6c757d;
    }

    /* Heatmap Styles */
    .heatmap-card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        background: #fff;
        overflow: hidden;
    }
    .heatmap-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 4px;
    }
    .heatmap-table th {
        text-align: center;
        font-size: 0.7rem;
        font-weight: 600;
        color: #6c757d;
        padding: 8px 4px;
        text-transform: uppercase;
    }
    .heatmap-table td {
        text-align: center;
        padding: 0;
    }
    .heatmap-cell {
        width: 100%;
        height: 40px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        transition: transform 0.2s ease;
    }
    .heatmap-cell:hover {
        transform: scale(1.1);
    }
    .heatmap-level-0 { background: #f1f3f4; color: #9aa0a6; }
    .heatmap-level-1 { background: #fff3cd; color: #856404; }
    .heatmap-level-2 { background: #ffc107; color: #664d00; }
    .heatmap-level-3 { background: #fd7e14; color: #fff; }
    .heatmap-level-4 { background: #dc3545; color: #fff; }
    .heatmap-level-5 { background: #721c24; color: #fff; }
    
    .heatmap-legend {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 1rem;
        font-size: 0.7rem;
        color: #6c757d;
    }
    .heatmap-legend-item {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }
</style>

<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1 fw-bold"><i class="fas fa-chart-line me-2 text-danger"></i>Analytics Dashboard</h2>
            <p class="text-muted mb-0">Comprehensive attendance insights and performance metrics</p>
        </div>
        <div class="text-muted">
            <i class="fas fa-calendar-alt me-1"></i>
            {{ start_date }} to {{ end_date }}
        </div>
    </div>

    <!-- Filters -->
    <div class="card filter-card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end" id="filterForm">
                <div class="col-xl-2 col-lg-3 col-md-4">
                    <label class="form-label">Period</label>
                    <select name="period" class="form-select" id="periodSelect">
                        <option value="today" {% if period == 'today' %}selected{% endif %}>Today</option>
                        <option value="7" {% if period == '7' %}selected{% endif %}>Last 7 Days</option>
                        <option value="14" {% if period == '14' %}selected{% endif %}>Last 14 Days</option>
                        <option value="30" {% if period == '30' %}selected{% endif %}>Last 30 Days</option>
                        <option value="this_week" {% if period == 'this_week' %}selected{% endif %}>This Week</option>
                        <option value="last_week" {% if period == 'last_week' %}selected{% endif %}>Last Week</option>
                        <option value="this_month" {% if period == 'this_month' %}selected{% endif %}>This Month</option>
                        <option value="last_month" {% if period == 'last_month' %}selected{% endif %}>Last Month</option>
                        <option value="custom" {% if period == 'custom' %}selected{% endif %}>Custom Range</option>
                    </select>
                </div>
                <div class="col-xl-2 col-lg-3 col-md-4 custom-date" style="{% if period != 'custom' %}display:none{% endif %}">
                    <label class="form-label">Start Date</label>
                    <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
                </div>
                <div class="col-xl-2 col-lg-3 col-md-4 custom-date" style="{% if period != 'custom' %}display:none{% endif %}">
                    <label class="form-label">End Date</label>
                    <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
                </div>
                {% if organizations %}
                <div class="col-xl-2 col-lg-3 col-md-4">
                    <label class="form-label">Organization</label>
                    <select name="organization_id" class="form-select">
                        <option value="">All Organizations</option>
                        {% for org in organizations %}
                        <option value="{{ org.id }}" {% if selected_organization_id == org.id|string %}selected{% endif %}>{{ org.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <div class="col-xl-2 col-lg-3 col-md-4">
                    <label class="form-label">Branch</label>
                    <select name="school_id" class="form-select">
                        <option value="">All Branches</option>
                        {% for school in schools %}
                        <option value="{{ school.id }}" {% if selected_school_id == school.id|string %}selected{% endif %}>{{ school.short_name or school.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-xl-2 col-lg-3 col-md-4">
                    <label class="form-label">Department</label>
                    <select name="department" class="form-select">
                        <option value="">All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept }}" {% if selected_department == dept %}selected{% endif %}>{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-xl-2 col-lg-3 col-md-4">
                    <button type="submit" class="btn btn-filter w-100">
                        <i class="fas fa-filter me-1"></i> Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Metrics Row 1 -->
    <div class="row mb-4 g-4">
        <div class="col-xl-3 col-sm-6">
            <div class="card metric-card soft-red h-100 shadow-sm">
                <div class="bg-shape"></div>
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="metric-label">Attendance Rate</p>
                            <h3 class="metric-value">{{ attendance_rate }}%</h3>
                            <span class="metric-trend {% if attendance_trend >= 0 %}up{% else %}down{% endif %}">
                                <i class="fas fa-{% if attendance_trend >= 0 %}arrow-up{% else %}arrow-down{% endif %} me-1"></i>
                                {{ attendance_trend|abs }}%
                            </span>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6">
            <div class="card metric-card soft-green h-100 shadow-sm">
                <div class="bg-shape"></div>
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="metric-label">Punctuality Rate</p>
                            <h3 class="metric-value">{{ punctuality_rate }}%</h3>
                            <span class="metric-trend {% if punctuality_trend >= 0 %}up{% else %}down{% endif %}">
                                <i class="fas fa-{% if punctuality_trend >= 0 %}arrow-up{% else %}arrow-down{% endif %} me-1"></i>
                                {{ punctuality_trend|abs }}%
                            </span>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6">
            <div class="card metric-card soft-blue h-100 shadow-sm">
                <div class="bg-shape"></div>
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="metric-label">Active Staff</p>
                            <h3 class="metric-value">{{ total_staff }}</h3>
                            <span class="metric-subtitle">
                                <i class="fas fa-building me-1"></i>
                                {{ branch_count }} branch{% if branch_count != 1 %}es{% endif %}
                            </span>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6">
            <div class="card metric-card soft-purple h-100 shadow-sm">
                <div class="bg-shape"></div>
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="metric-label">Total Records</p>
                            <h3 class="metric-value">{{ total_records }}</h3>
                            <span class="metric-subtitle">
                                <i class="fas fa-calendar-check me-1"></i>
                                In selected period
                            </span>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Row 2 -->
    <div class="row mb-4 g-4">
        <div class="col-xl-3 col-sm-6">
            <div class="card metric-card soft-teal h-100 shadow-sm">
                <div class="bg-shape"></div>
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="metric-label">On Time Arrivals</p>
                            <h3 class="metric-value">{{ on_time_count }}</h3>
                            <span class="metric-subtitle text-success">
                                <i class="fas fa-check-circle me-1"></i>
                                Early / On-time
                            </span>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6">
            <div class="card metric-card soft-orange h-100 shadow-sm">
                <div class="bg-shape"></div>
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="metric-label">Late Arrivals</p>
                            <h3 class="metric-value">{{ late_count }}</h3>
                            <span class="metric-subtitle text-warning">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                After start time
                            </span>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-user-clock"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6">
            <div class="card metric-card soft-pink h-100 shadow-sm">
                <div class="bg-shape"></div>
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="metric-label">Avg Late Time</p>
                            <h3 class="metric-value">{{ avg_late_minutes }} <small class="fs-6 fw-normal">min</small></h3>
                            <span class="metric-subtitle">
                                <i class="fas fa-stopwatch me-1"></i>
                                Per late arrival
                            </span>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6">
            <div class="card metric-card soft-dark h-100 shadow-sm">
                <div class="bg-shape"></div>
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="metric-label">Total Overtime</p>
                            <h3 class="metric-value">{{ overtime_hours }}<small class="fs-6 fw-normal">h</small> {{ overtime_mins }}<small class="fs-6 fw-normal">m</small></h3>
                            <span class="metric-subtitle">
                                <i class="fas fa-business-time me-1"></i>
                                Extra hours worked
                            </span>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-briefcase"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row mb-4 g-4">
        <div class="col-lg-8">
            <div class="card chart-card h-100">
                <div class="card-header d-flex align-items-center">
                    <span class="header-icon" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                        <i class="fas fa-chart-area"></i>
                    </span>
                    <h5 class="mb-0">Attendance & Punctuality Trend</h5>
                </div>
                <div class="card-body">
                    <canvas id="attendanceTrendChart" height="100"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card chart-card h-100">
                <div class="card-header d-flex align-items-center">
                    <span class="header-icon" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);">
                        <i class="fas fa-calendar-week"></i>
                    </span>
                    <h5 class="mb-0">Late by Day of Week</h5>
                </div>
                <div class="card-body">
                    <canvas id="lateByDayChart" height="220"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row mb-4 g-4">
        <div class="col-lg-5">
            <div class="card chart-card h-100">
                <div class="card-header d-flex align-items-center">
                    <span class="header-icon" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);">
                        <i class="fas fa-sitemap"></i>
                    </span>
                    <h5 class="mb-0">Department Performance</h5>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center" style="min-height: 280px;">
                    {% if department_labels %}
                    <canvas id="departmentChart"></canvas>
                    {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-chart-pie fa-3x mb-3" style="opacity: 0.2;"></i>
                        <p class="mb-0">No department data available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="card chart-card h-100">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <span class="header-icon" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
                            <i class="fas fa-code-branch"></i>
                        </span>
                        <h5 class="mb-0">Branch Comparison</h5>
                    </div>
                    <small class="text-muted"><i class="fas fa-info-circle me-1"></i>vs previous period</small>
                </div>
                <div class="card-body">
                    {% if branch_labels %}
                    <canvas id="branchChart" height="160"></canvas>
                    <div class="mt-3 pt-3 border-top">
                        <div class="d-flex flex-wrap justify-content-center gap-3">
                            {% for i in range(branch_labels|length) %}
                            <div class="d-flex align-items-center">
                                <span class="fw-semibold me-2" style="font-size: 0.8rem;">{{ branch_labels[i] }}</span>
                                {% if branch_trends[i] > 0 %}
                                <span class="trend-badge up">
                                    <i class="fas fa-arrow-up me-1"></i>+{{ branch_trends[i] }}%
                                </span>
                                {% elif branch_trends[i] < 0 %}
                                <span class="trend-badge down">
                                    <i class="fas fa-arrow-down me-1"></i>{{ branch_trends[i] }}%
                                </span>
                                {% else %}
                                <span class="trend-badge neutral">
                                    <i class="fas fa-minus me-1"></i>0%
                                </span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-code-branch fa-3x mb-3" style="opacity: 0.2;"></i>
                        <p class="mb-0">No branch data available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Phase 3: Heatmap Row -->
    <div class="row mb-4 g-4">
        <div class="col-12">
            <div class="card heatmap-card">
                <div class="card-header d-flex align-items-center">
                    <span class="header-icon" style="background: linear-gradient(135deg, #e83e8c 0%, #d31a72 100%);">
                        <i class="fas fa-fire"></i>
                    </span>
                    <h5 class="mb-0">Late Arrivals Heatmap</h5>
                    <small class="text-muted ms-auto"><i class="fas fa-info-circle me-1"></i>When do late arrivals happen most?</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="heatmap-table">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">Time</th>
                                    <th>Mon</th>
                                    <th>Tue</th>
                                    <th>Wed</th>
                                    <th>Thu</th>
                                    <th>Fri</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for hour_idx in range(hour_labels|length) %}
                                <tr>
                                    <td class="text-muted fw-semibold" style="font-size: 0.8rem;">{{ hour_labels[hour_idx] }}</td>
                                    {% for day_idx in range(5) %}
                                    {% set value = heatmap_data[hour_idx][day_idx] %}
                                    {% set level = 0 %}
                                    {% if heatmap_max > 0 %}
                                        {% if value == 0 %}
                                            {% set level = 0 %}
                                        {% elif value <= heatmap_max * 0.2 %}
                                            {% set level = 1 %}
                                        {% elif value <= heatmap_max * 0.4 %}
                                            {% set level = 2 %}
                                        {% elif value <= heatmap_max * 0.6 %}
                                            {% set level = 3 %}
                                        {% elif value <= heatmap_max * 0.8 %}
                                            {% set level = 4 %}
                                        {% else %}
                                            {% set level = 5 %}
                                        {% endif %}
                                    {% endif %}
                                    <td>
                                        <div class="heatmap-cell heatmap-level-{{ level }}">
                                            {{ value if value > 0 else '-' }}
                                        </div>
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="heatmap-legend">
                        <span>Less</span>
                        <div class="heatmap-legend-item heatmap-level-0"></div>
                        <div class="heatmap-legend-item heatmap-level-1"></div>
                        <div class="heatmap-legend-item heatmap-level-2"></div>
                        <div class="heatmap-legend-item heatmap-level-3"></div>
                        <div class="heatmap-legend-item heatmap-level-4"></div>
                        <div class="heatmap-legend-item heatmap-level-5"></div>
                        <span>More</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
                                            <!-- Early Arrivals Champions -->
            <div class="col-md-6 mb-4">
                <div class="ranking-card">
                    <div class="ranking-card-header">
                        <h5 class="mb-0">üåÖ Early Arrivals Champions</h5>
                    </div>
                    <div class="ranking-card-body">
                        {% if early_arrivals %}
                            {% for staff in early_arrivals[:5] %}
                            <div class="ranking-item">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="rank-badge {% if loop.index <= 3 %}top-3{% endif %}">{{ loop.index }}</span>
                                    <span class="fw-medium">{{ staff.name }}</span>
                                </div>
                                <span class="score-badge excellent">{{ staff.early_count }} early</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted mb-0">No early arrivals data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Perfect Attendance -->
            <div class="col-md-6 mb-4">
                <div class="ranking-card">
                    <div class="ranking-card-header">
                        <h5 class="mb-0">‚≠ê Perfect Attendance</h5>
                    </div>
                    <div class="ranking-card-body">
                        {% if perfect_attendance %}
                            {% for staff in perfect_attendance[:5] %}
                            <div class="ranking-item">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="rank-badge {% if loop.index <= 3 %}top-3{% endif %}">{{ loop.index }}</span>
                                    <span class="fw-medium">{{ staff.name }}</span>
                                </div>
                                <span class="score-badge excellent">{{ staff.days }} days</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted mb-0">No perfect attendance data</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Most Improved -->
            <div class="col-md-6 mb-4">
                <div class="ranking-card">
                    <div class="ranking-card-header">
                        <h5 class="mb-0">üìà Most Improved</h5>
                    </div>
                    <div class="ranking-card-body">
                        {% if most_improved %}
                            {% for staff in most_improved[:5] %}
                            <div class="ranking-item">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="rank-badge {% if loop.index <= 3 %}top-3{% endif %}">{{ loop.index }}</span>
                                    <span class="fw-medium">{{ staff.name }}</span>
                                </div>
                                <span class="score-badge {% if staff.improvement > 20 %}excellent{% elif staff.improvement > 10 %}good{% else %}average{% endif %}">
                                    +{{ "%.0f"|format(staff.improvement) }}%
                                </span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted mb-0">No improvement data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Attendance Streaks -->
            <div class="col-md-6 mb-4">
                <div class="ranking-card">
                    <div class="ranking-card-header">
                        <h5 class="mb-0">üî• On-Time Streaks</h5>
                    </div>
                    <div class="ranking-card-body">
                        {% if attendance_streaks %}
                            {% for staff in attendance_streaks[:5] %}
                            <div class="ranking-item">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="rank-badge {% if loop.index <= 3 %}top-3{% endif %}">{{ loop.index }}</span>
                                    <span class="fw-medium">{{ staff.name }}</span>
                                </div>
                                <span class="score-badge excellent">{{ staff.streak }} days</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted mb-0">No streak data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Attendance & Punctuality Trend Chart
const trendCtx = document.getElementById('trendChart').getContext('2d');
new Chart(trendCtx, {
    type: 'line',
    data: {
        labels: {{ trend_labels|safe }},
        datasets: [
            {
                label: 'Attendance Rate',
                data: {{ attendance_trend|safe }},
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                fill: true,
                tension: 0.4
            },
            {
                label: 'Punctuality Rate',
                data: {{ punctuality_trend|safe }},
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                fill: true,
                tension: 0.4
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' }
        },
        scales: {
            y: { beginAtZero: true, max: 100 }
        }
    }
});

// Late by Day of Week Chart
const dayCtx = document.getElementById('lateByDayChart').getContext('2d');
new Chart(dayCtx, {
    type: 'bar',
    data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
        datasets: [{
            label: 'Late Arrivals',
            data: {{ late_by_day|safe }},
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: { beginAtZero: true }
        }
    }
});

// Department Performance Chart
const deptCtx = document.getElementById('departmentChart').getContext('2d');
new Chart(deptCtx, {
    type: 'doughnut',
    data: {
        labels: {{ dept_labels|safe }},
        datasets: [{
            data: {{ dept_punctuality|safe }},
            backgroundColor: ['#28a745', '#007bff', '#ffc107', '#dc3545', '#6f42c1', '#20c997']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' }
        }
    }
});

// Branch Comparison Chart
const branchCtx = document.getElementById('branchChart').getContext('2d');
new Chart(branchCtx, {
    type: 'bar',
    data: {
        labels: {{ branch_labels|safe }},
        datasets: [
            {
                label: 'Attendance %',
                data: {{ branch_attendance|safe }},
                backgroundColor: 'rgba(40, 167, 69, 0.8)'
            },
            {
                label: 'Punctuality %',
                data: {{ branch_punctuality|safe }},
                backgroundColor: 'rgba(0, 123, 255, 0.8)'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' }
        },
        scales: {
            y: { beginAtZero: true, max: 100 }
        }
    }
});
</script>
{% endblock %}
