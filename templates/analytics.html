{% extends 'base.html' %}

{% block title %}Analytics Dashboard - Attendance System{% endblock %}

{% block content %}
<style>
    .metric-card {
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        color: white;
        margin-bottom: 15px;
    }
    .metric-card h2 {
        font-size: 2.5rem;
        margin-bottom: 5px;
    }
    .metric-card small {
        opacity: 0.9;
    }
    .bg-gradient-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .bg-gradient-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .bg-gradient-info { background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%); }
    .bg-gradient-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .bg-gradient-secondary { background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%); }
    .bg-gradient-dark { background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%); }
    .chart-container {
        position: relative;
        height: 300px;
    }
    .ranking-table th, .ranking-table td {
        padding: 8px 12px;
    }
    .badge-rank {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-line me-2"></i>Analytics Dashboard</h2>
    <a href="{{ url_for('download_analytics_pdf') }}" class="btn btn-outline-danger">
        <i class="fas fa-file-pdf me-1"></i>Download PDF
    </a>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Period</label>
                <select name="period" class="form-select">
                    <option value="7" {% if selected_period == '7' %}selected{% endif %}>Last 7 Days</option>
                    <option value="30" {% if selected_period == '30' or not selected_period %}selected{% endif %}>Last 30 Days</option>
                    <option value="90" {% if selected_period == '90' %}selected{% endif %}>Last 90 Days</option>
                    <option value="365" {% if selected_period == '365' %}selected{% endif %}>Last Year</option>
                </select>
            </div>
            {% if current_user.role == 'super_admin' %}
            <div class="col-md-3">
                <label class="form-label">Organization</label>
                <select name="organization" class="form-select">
                    <option value="">All Organizations</option>
                    {% for org in organizations %}
                    <option value="{{ org.id }}" {% if selected_org|string == org.id|string %}selected{% endif %}>{{ org.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="col-md-3">
                <label class="form-label">Branch</label>
                <select name="school" class="form-select">
                    <option value="">All Branches</option>
                    {% for school in schools %}
                    <option value="{{ school.id }}" {% if selected_school|string == school.id|string %}selected{% endif %}>{{ school.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Department</label>
                <select name="department" class="form-select">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept }}" {% if selected_department == dept %}selected{% endif %}>{{ dept }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter me-1"></i>Apply Filters
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Metric Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card bg-gradient-primary">
            <i class="fas fa-chart-pie fa-2x mb-2"></i>
            <h2>{{ attendance_rate|default(0) }}%</h2>
            <small>Attendance Rate</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card bg-gradient-success">
            <i class="fas fa-clock fa-2x mb-2"></i>
            <h2>{{ punctuality_rate|default(0) }}%</h2>
            <small>Punctuality Rate</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card bg-gradient-info">
            <i class="fas fa-users fa-2x mb-2"></i>
            <h2>{{ total_staff|default(0) }}</h2>
            <small>Active Staff</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card bg-gradient-secondary">
            <i class="fas fa-calendar-check fa-2x mb-2"></i>
            <h2>{{ total_records|default(0) }}</h2>
            <small>Total Records</small>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card bg-gradient-success">
            <h2>{{ on_time_count|default(0) }}</h2>
            <small>On Time Arrivals</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card bg-gradient-warning">
            <h2>{{ late_count|default(0) }}</h2>
            <small>Late Arrivals</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card bg-gradient-dark">
            <h2>{{ avg_late_time|default(0) }} min</h2>
            <small>Avg Late Time</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card bg-gradient-info">
            <h2>{{ overtime_hours|default(0) }} hrs</h2>
            <small>Total Overtime</small>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-line me-2"></i>Attendance & Punctuality Trend
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-clock me-2"></i>Late Arrivals by Day
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="lateByDayChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-building me-2"></i>Department Performance
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-code-branch me-2"></i>Branch Comparison
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="branchChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 3 -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-clock me-2"></i>Arrival Time Distribution
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="arrivalChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-pie me-2"></i>Present vs Absent
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="presentAbsentChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-calendar-week me-2"></i>Weekly Comparison
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rankings -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <i class="fas fa-trophy me-2"></i>Top Performers
            </div>
            <div class="card-body p-0">
                <table class="table table-hover ranking-table mb-0">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Branch</th>
                            <th>Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for performer in top_performers %}
                        <tr>
                            <td><span class="badge-rank bg-success text-white">{{ loop.index }}</span></td>
                            <td>{{ performer.name }}</td>
                            <td>{{ performer.school }}</td>
                            <td><span class="badge bg-success">{{ performer.rate }}%</span></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="text-center text-muted">No data available</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <i class="fas fa-exclamation-triangle me-2"></i>Needs Attention
            </div>
            <div class="card-body p-0">
                <table class="table table-hover ranking-table mb-0">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Branch</th>
                            <th>Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for person in needs_attention %}
                        <tr>
                            <td><span class="badge-rank bg-warning text-dark">{{ loop.index }}</span></td>
                            <td>{{ person.name }}</td>
                            <td>{{ person.school }}</td>
                            <td><span class="badge bg-danger">{{ person.rate }}%</span></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="text-center text-muted">No data available</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="fas fa-sun me-2"></i>Early Arrivals Champions
            </div>
            <div class="card-body p-0">
                <table class="table table-hover ranking-table mb-0">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Early Days</th>
                            <th>Avg Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for person in early_arrivals %}
                        <tr>
                            <td><span class="badge-rank bg-info text-white">{{ loop.index }}</span></td>
                            <td>{{ person.name }}</td>
                            <td>{{ person.early_days }}</td>
                            <td>{{ person.avg_time }}</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="text-center text-muted">No data available</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-star me-2"></i>Perfect Attendance
            </div>
            <div class="card-body p-0">
                <table class="table table-hover ranking-table mb-0">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Branch</th>
                            <th>Days</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for person in perfect_attendance %}
                        <tr>
                            <td><span class="badge-rank bg-primary text-white">{{ loop.index }}</span></td>
                            <td>{{ person.name }}</td>
                            <td>{{ person.school }}</td>
                            <td>{{ person.days }}</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="text-center text-muted">No data available</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Trend Chart
new Chart(document.getElementById('trendChart'), {
    type: 'line',
    data: {
        labels: {{ trend_labels|default([])|tojson }},
        datasets: [{
            label: 'Attendance',
            data: {{ attendance_trend|default([])|tojson }},
            borderColor: '#667eea',
            tension: 0.3,
            fill: false
        }, {
            label: 'Punctuality %',
            data: {{ punctuality_trend|default([])|tojson }},
            borderColor: '#11998e',
            tension: 0.3,
            fill: false,
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: { beginAtZero: true },
            y1: { position: 'right', beginAtZero: true, max: 100 }
        }
    }
});

// Late by Day Chart
new Chart(document.getElementById('lateByDayChart'), {
    type: 'bar',
    data: {
        labels: {{ day_names|default(['Mon','Tue','Wed','Thu','Fri','Sat','Sun'])|tojson }},
        datasets: [{
            label: 'Late Arrivals',
            data: {{ late_by_day|default([0,0,0,0,0,0,0])|tojson }},
            backgroundColor: '#f5576c'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } }
    }
});

// Department Chart
new Chart(document.getElementById('departmentChart'), {
    type: 'bar',
    data: {
        labels: {{ department_labels|default(['No Data'])|tojson }},
        datasets: [{
            label: 'Attendance Rate %',
            data: {{ department_data|default([0])|tojson }},
            backgroundColor: '#667eea'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        scales: { x: { beginAtZero: true, max: 100 } }
    }
});

// Branch Chart
new Chart(document.getElementById('branchChart'), {
    type: 'bar',
    data: {
        labels: {{ branch_labels|default(['No Data'])|tojson }},
        datasets: [{
            label: 'Attendance Rate %',
            data: {{ branch_data|default([0])|tojson }},
            backgroundColor: '#38ef7d'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true, max: 100 } }
    }
});

// Arrival Distribution Chart
new Chart(document.getElementById('arrivalChart'), {
    type: 'bar',
    data: {
        labels: {{ arrival_labels|default(['6:00','7:00','8:00','9:00','10:00','11:00'])|tojson }},
        datasets: [{
            label: 'Arrivals',
            data: {{ arrival_data|default([0,0,0,0,0,0])|tojson }},
            backgroundColor: '#6dd5ed'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } }
    }
});

// Present vs Absent Pie Chart
new Chart(document.getElementById('presentAbsentChart'), {
    type: 'doughnut',
    data: {
        labels: ['Present', 'Absent'],
        datasets: [{
            data: [{{ present_count|default(0) }}, {{ absent_count|default(0) }}],
            backgroundColor: ['#38ef7d', '#f5576c']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});

// Weekly Comparison Chart
new Chart(document.getElementById('weeklyChart'), {
    type: 'bar',
    data: {
        labels: {{ weekly_labels|default(['This Week', 'Last Week'])|tojson }},
        datasets: [{
            label: 'Records',
            data: {{ weekly_data|default([0,0])|tojson }},
            backgroundColor: ['#667eea', '#764ba2']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } }
    }
});
</script>
{% endblock %}
