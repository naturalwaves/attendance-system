{% extends "base.html" %}

{% block title %}Analytics - Attendance System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-chart-line me-2"></i>Analytics Dashboard</h2>
    </div>

    <!-- Filters -->
    <div class="card mb-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%); border: none; box-shadow: 0 2px 12px rgba(0,0,0,0.08);">
        <div class="card-body">
            <form method="GET" class="row g-3" id="filterForm">
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Period</label>
                    <select name="period" class="form-select" id="periodSelect">
                        <option value="today" {% if period == 'today' %}selected{% endif %}>Today</option>
                        <option value="7" {% if period == '7' %}selected{% endif %}>Last 7 Days</option>
                        <option value="14" {% if period == '14' %}selected{% endif %}>Last 14 Days</option>
                        <option value="30" {% if period == '30' %}selected{% endif %}>Last 30 Days</option>
                        <option value="this_week" {% if period == 'this_week' %}selected{% endif %}>This Week</option>
                        <option value="last_week" {% if period == 'last_week' %}selected{% endif %}>Last Week</option>
                        <option value="this_month" {% if period == 'this_month' %}selected{% endif %}>This Month</option>
                        <option value="last_month" {% if period == 'last_month' %}selected{% endif %}>Last Month</option>
                        <option value="custom" {% if period == 'custom' %}selected{% endif %}>Custom Range</option>
                    </select>
                </div>
                <div class="col-md-2 custom-date" style="{% if period != 'custom' %}display:none{% endif %}">
                    <label class="form-label fw-semibold">Start Date</label>
                    <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
                </div>
                <div class="col-md-2 custom-date" style="{% if period != 'custom' %}display:none{% endif %}">
                    <label class="form-label fw-semibold">End Date</label>
                    <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
                </div>
                {% if organizations %}
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Organization</label>
                    <select name="organization_id" class="form-select" id="orgSelect">
                        <option value="">All Organizations</option>
                        {% for org in organizations %}
                        <option value="{{ org.id }}" {% if selected_organization_id == org.id|string %}selected{% endif %}>{{ org.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Branch</label>
                    <select name="school_id" class="form-select">
                        <option value="">All Branches</option>
                        {% for school in schools %}
                        <option value="{{ school.id }}" {% if selected_school_id == school.id|string %}selected{% endif %}>{{ school.short_name or school.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Department</label>
                    <select name="department" class="form-select">
                        <option value="">All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept }}" {% if selected_department == dept %}selected{% endif %}>{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="fas fa-filter me-1"></i> Apply
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Key Metrics Cards - Row 1 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #dc3545 !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 0.5px;">Attendance Rate</h6>
                            <h2 class="mb-1 fw-bold">{{ attendance_rate }}%</h2>
                            <div class="{% if attendance_trend >= 0 %}text-success{% else %}text-danger{% endif %}" style="font-size: 0.85rem;">
                                <i class="fas fa-{% if attendance_trend >= 0 %}arrow-up{% else %}arrow-down{% endif %} me-1"></i>
                                {{ attendance_trend|abs }}% vs prev period
                            </div>
                        </div>
                        <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 56px; height: 56px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                            <i class="fas fa-chart-pie text-white" style="font-size: 1.4rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #28a745 !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 0.5px;">Punctuality Rate</h6>
                            <h2 class="mb-1 fw-bold">{{ punctuality_rate }}%</h2>
                            <div class="{% if punctuality_trend >= 0 %}text-success{% else %}text-danger{% endif %}" style="font-size: 0.85rem;">
                                <i class="fas fa-{% if punctuality_trend >= 0 %}arrow-up{% else %}arrow-down{% endif %} me-1"></i>
                                {{ punctuality_trend|abs }}% vs prev period
                            </div>
                        </div>
                        <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 56px; height: 56px; background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
                            <i class="fas fa-clock text-white" style="font-size: 1.4rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #007bff !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 0.5px;">Active Staff</h6>
                            <h2 class="mb-1 fw-bold">{{ total_staff }}</h2>
                            <div class="text-muted" style="font-size: 0.85rem;">
                                <i class="fas fa-building me-1"></i>
                                {{ branch_count }} branch{% if branch_count != 1 %}es{% endif %}
                            </div>
                        </div>
                        <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 56px; height: 56px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);">
                            <i class="fas fa-users text-white" style="font-size: 1.4rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #6f42c1 !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 0.5px;">Attendance Records</h6>
                            <h2 class="mb-1 fw-bold">{{ total_records }}</h2>
                            <div class="text-muted" style="font-size: 0.85rem;">
                                <i class="fas fa-calendar-check me-1"></i>
                                In selected period
                            </div>
                        </div>
                        <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 56px; height: 56px; background: linear-gradient(135deg, #6f42c1 0%, #59359a 100%);">
                            <i class="fas fa-clipboard-list text-white" style="font-size: 1.4rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards - Row 2 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #17a2b8 !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 0.5px;">On Time Arrivals</h6>
                            <h2 class="mb-1 fw-bold">{{ on_time_count }}</h2>
                            <div class="text-success" style="font-size: 0.85rem;">
                                <i class="fas fa-check-circle me-1"></i>
                                Early/On-time
                            </div>
                        </div>
                        <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 56px; height: 56px; background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);">
                            <i class="fas fa-check text-white" style="font-size: 1.4rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #ffc107 !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 0.5px;">Late Arrivals</h6>
                            <h2 class="mb-1 fw-bold">{{ late_count }}</h2>
                            <div class="text-warning" style="font-size: 0.85rem;">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                After start time
                            </div>
                        </div>
                        <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 56px; height: 56px; background: linear-gradient(135deg, #ffc107 0%, #d39e00 100%);">
                            <i class="fas fa-hourglass-half text-white" style="font-size: 1.4rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #fd7e14 !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 0.5px;">Avg Late Time</h6>
                            <h2 class="mb-1 fw-bold">{{ avg_late_minutes }} min</h2>
                            <div class="text-muted" style="font-size: 0.85rem;">
                                <i class="fas fa-stopwatch me-1"></i>
                                Per late arrival
                            </div>
                        </div>
                        <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 56px; height: 56px; background: linear-gradient(135deg, #fd7e14 0%, #dc6502 100%);">
                            <i class="fas fa-stopwatch text-white" style="font-size: 1.4rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #20c997 !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 0.5px;">Total Overtime</h6>
                            <h2 class="mb-1 fw-bold">{{ overtime_hours }}h {{ overtime_mins }}m</h2>
                            <div class="text-muted" style="font-size: 0.85rem;">
                                <i class="fas fa-business-time me-1"></i>
                                Extra hours worked
                            </div>
                        </div>
                        <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 56px; height: 56px; background: linear-gradient(135deg, #20c997 0%, #17a689 100%);">
                            <i class="fas fa-business-time text-white" style="font-size: 1.4rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 pt-3">
                    <h5 class="mb-0"><i class="fas fa-chart-area text-danger me-2"></i>Attendance Trend</h5>
                </div>
                <div class="card-body">
                    <canvas id="attendanceTrendChart" height="100"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 pt-3">
                    <h5 class="mb-0"><i class="fas fa-calendar-week text-warning me-2"></i>Late Arrivals by Day</h5>
                </div>
                <div class="card-body">
                    <canvas id="lateByDayChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 pt-3">
                    <h5 class="mb-0"><i class="fas fa-building text-primary me-2"></i>Department Performance</h5>
                </div>
                <div class="card-body">
                    {% if department_labels %}
                    <canvas id="departmentChart" height="200"></canvas>
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-chart-bar fa-3x mb-3 opacity-50"></i>
                        <p>No department data available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 pt-3">
                    <h5 class="mb-0"><i class="fas fa-code-branch text-success me-2"></i>Branch Comparison</h5>
                </div>
                <div class="card-body">
                    {% if branch_labels %}
                    <canvas id="branchChart" height="200"></canvas>
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-code-branch fa-3x mb-3 opacity-50"></i>
                        <p>No branch data available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Rankings Row 1 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header text-white border-0 pt-3" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
                    <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Top Performers</h5>
                </div>
                <div class="card-body p-0">
                    {% if top_performers %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Staff</th>
                                    <th>Branch</th>
                                    <th class="text-end">Punctuality</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for staff in top_performers %}
                                <tr>
                                    <td>
                                        {% if loop.index == 1 %}
                                        <span class="badge bg-warning text-dark"><i class="fas fa-medal"></i></span>
                                        {% elif loop.index == 2 %}
                                        <span class="badge bg-secondary"><i class="fas fa-medal"></i></span>
                                        {% elif loop.index == 3 %}
                                        <span class="badge" style="background: #cd7f32;"><i class="fas fa-medal"></i></span>
                                        {% else %}
                                        <span class="text-muted">{{ loop.index }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="fw-semibold">{{ staff.name }}</td>
                                    <td><span class="badge bg-light text-dark">{{ staff.branch }}</span></td>
                                    <td class="text-end">
                                        <span class="badge bg-success">{{ staff.punctuality }}%</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-trophy fa-2x mb-2 opacity-50"></i>
                        <p class="mb-0">No data available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header text-white border-0 pt-3" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                    <h5 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>Needs Attention</h5>
                </div>
                <div class="card-body p-0">
                    {% if needs_attention %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Staff</th>
                                    <th>Branch</th>
                                    <th class="text-end">Late Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for staff in needs_attention %}
                                <tr>
                                    <td><span class="text-muted">{{ loop.index }}</span></td>
                                    <td class="fw-semibold">{{ staff.name }}</td>
                                    <td><span class="badge bg-light text-dark">{{ staff.branch }}</span></td>
                                    <td class="text-end">
                                        <span class="badge bg-danger">{{ staff.late_count }} times</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-2x mb-2 text-success opacity-50"></i>
                        <p class="mb-0">Everyone is doing great!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Rankings Row 2 - Phase 2 Features -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header text-white border-0 pt-3" style="background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);">
                    <h5 class="mb-0"><i class="fas fa-sun me-2"></i>Early Arrivals</h5>
                </div>
                <div class="card-body p-0">
                    {% if early_arrivals %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Staff</th>
                                    <th>Branch</th>
                                    <th class="text-end">Early Days</th>
                                    <th class="text-end">Avg Early</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for staff in early_arrivals %}
                                <tr>
                                    <td>
                                        {% if loop.index == 1 %}
                                        <span class="badge bg-info"><i class="fas fa-star"></i></span>
                                        {% else %}
                                        <span class="text-muted">{{ loop.index }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="fw-semibold">{{ staff.name }}</td>
                                    <td><span class="badge bg-light text-dark">{{ staff.branch }}</span></td>
                                    <td class="text-end">
                                        <span class="badge bg-info">{{ staff.early_count }} days</span>
                                    </td>
                                    <td class="text-end">
                                        <span class="text-muted">{{ staff.avg_early_mins }} min</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-sun fa-2x mb-2 opacity-50"></i>
                        <p class="mb-0">No early arrivals data</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header text-white border-0 pt-3" style="background: linear-gradient(135deg, #6f42c1 0%, #59359a 100%);">
                    <h5 class="mb-0"><i class="fas fa-award me-2"></i>Perfect Attendance</h5>
                </div>
                <div class="card-body p-0">
                    {% if perfect_attendance %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Staff</th>
                                    <th>Branch</th>
                                    <th class="text-end">Days</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for staff in perfect_attendance %}
                                <tr>
                                    <td>
                                        {% if loop.index == 1 %}
                                        <span class="badge bg-warning text-dark"><i class="fas fa-crown"></i></span>
                                        {% else %}
                                        <span class="text-muted">{{ loop.index }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="fw-semibold">{{ staff.name }}</td>
                                    <td><span class="badge bg-light text-dark">{{ staff.branch }}</span></td>
                                    <td class="text-end">
                                        <span class="badge" style="background: #6f42c1;">{{ staff.days }} days</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-award fa-2x mb-2 opacity-50"></i>
                        <p class="mb-0">No perfect attendance yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Rankings Row 3 - Phase 2 Features -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header text-white border-0 pt-3" style="background: linear-gradient(135deg, #20c997 0%, #17a689 100%);">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Most Improved</h5>
                </div>
                <div class="card-body p-0">
                    {% if most_improved %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Staff</th>
                                    <th>Branch</th>
                                    <th class="text-end">Improvement</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for staff in most_improved %}
                                <tr>
                                    <td>
                                        {% if loop.index == 1 %}
                                        <span class="badge" style="background: #20c997;"><i class="fas fa-arrow-up"></i></span>
                                        {% else %}
                                        <span class="text-muted">{{ loop.index }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="fw-semibold">{{ staff.name }}</td>
                                    <td><span class="badge bg-light text-dark">{{ staff.branch }}</span></td>
                                    <td class="text-end">
                                        <span class="text-danger text-decoration-line-through me-1">{{ staff.prev_late }}</span>
                                        <i class="fas fa-arrow-right text-muted mx-1"></i>
                                        <span class="badge bg-success">{{ staff.curr_late }} late</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-chart-line fa-2x mb-2 opacity-50"></i>
                        <p class="mb-0">No improvement data yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header text-white border-0 pt-3" style="background: linear-gradient(135deg, #fd7e14 0%, #dc6502 100%);">
                    <h5 class="mb-0"><i class="fas fa-fire me-2"></i>Attendance Streaks</h5>
                </div>
                <div class="card-body p-0">
                    {% if attendance_streaks %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Staff</th>
                                    <th>Branch</th>
                                    <th class="text-end">Streak</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for staff in attendance_streaks %}
                                <tr>
                                    <td>
                                        {% if loop.index == 1 %}
                                        <span class="badge" style="background: #fd7e14;"><i class="fas fa-fire"></i></span>
                                        {% else %}
                                        <span class="text-muted">{{ loop.index }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="fw-semibold">{{ staff.name }}</td>
                                    <td><span class="badge bg-light text-dark">{{ staff.branch }}</span></td>
                                    <td class="text-end">
                                        <span class="badge" style="background: #fd7e14;">{{ staff.streak }} days <i class="fas fa-fire ms-1"></i></span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-fire fa-2x mb-2 opacity-50"></i>
                        <p class="mb-0">No streaks yet (min 3 days)</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Period select handler
    document.getElementById('periodSelect').addEventListener('change', function() {
        var customDates = document.querySelectorAll('.custom-date');
        if (this.value === 'custom') {
            customDates.forEach(function(el) { el.style.display = 'block'; });
        } else {
            customDates.forEach(function(el) { el.style.display = 'none'; });
        }
    });

    // Attendance Trend Chart
    var trendCtx = document.getElementById('attendanceTrendChart').getContext('2d');
    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: {{ trend_labels | tojson }},
            datasets: [{
                label: 'Attendance %',
                data: {{ trend_data | tojson }},
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                fill: true,
                tension: 0.4
            }, {
                label: 'Punctuality %',
                data: {{ punctuality_data | tojson }},
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true, max: 100 }
            }
        }
    });

    // Late by Day Chart
    var lateCtx = document.getElementById('lateByDayChart').getContext('2d');
    new Chart(lateCtx, {
        type: 'bar',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Late Arrivals',
                data: {{ late_by_day | tojson }},
                backgroundColor: '#ffc107'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            }
        }
    });

    {% if department_labels %}
    // Department Chart
    var deptCtx = document.getElementById('departmentChart').getContext('2d');
    new Chart(deptCtx, {
        type: 'doughnut',
        data: {
            labels: {{ department_labels | tojson }},
            datasets: [{
                data: {{ department_data | tojson }},
                backgroundColor: ['#dc3545', '#007bff', '#28a745', '#6f42c1']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
    {% endif %}

    {% if branch_labels %}
    // Branch Chart
    var branchCtx = document.getElementById('branchChart').getContext('2d');
    new Chart(branchCtx, {
        type: 'bar',
        data: {
            labels: {{ branch_labels | tojson }},
            datasets: [{
                label: 'Attendance %',
                data: {{ branch_attendance | tojson }},
                backgroundColor: '#dc3545'
            }, {
                label: 'Punctuality %',
                data: {{ branch_punctuality | tojson }},
                backgroundColor: '#28a745'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true, max: 100 }
            }
        }
    });
    {% endif %}
});
</script>
{% endblock %}
