{% extends "base.html" %}

{% block title %}Dashboard - Attendance System{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header">
        <div class="header-left">
            <h1>üìä Dashboard</h1>
            <div class="search-container">
                <input type="text" id="staffSearch" class="staff-search" placeholder="Search staff... (Ctrl+K)">
                <div id="searchResults" class="search-results"></div>
            </div>
        </div>
        
        <div class="header-center">
            <div class="first-checkin-card" id="firstCheckinCard">
                <div class="first-checkin-icon">üèÜ</div>
                <div class="first-checkin-info">
                    <span class="first-checkin-label">First Check-in Today</span>
                    <span class="first-checkin-name" id="firstCheckinName">---</span>
                    <span class="first-checkin-details" id="firstCheckinDetails">---</span>
                </div>
                <div class="first-checkin-time" id="firstCheckinTime">--:--</div>
            </div>
        </div>
        
        <div class="header-right">
            <div class="greeting" id="greeting">Good morning</div>
            <div class="clock-container">
                <div class="analog-clock">
                    <div class="clock-face">
                        <div class="clock-hand hour-hand" id="hourHand"></div>
                        <div class="clock-hand minute-hand" id="minuteHand"></div>
                        <div class="clock-hand second-hand" id="secondHand"></div>
                        <div class="clock-center"></div>
                    </div>
                </div>
                <div class="digital-clock" id="digitalClock">00:00:00</div>
            </div>
        </div>
    </div>

    <!-- Live Activity Ticker -->
    <div class="live-ticker-container">
        <div class="live-badge">
            <span class="live-dot"></span>
            LIVE
        </div>
        <div class="ticker-wrapper">
            <div class="ticker-content" id="tickerContent">
                <span class="ticker-item">Loading activity...</span>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card stat-schools">
            <div class="card-decoration"></div>
            <div class="stat-icon">üè¢</div>
            <div class="stat-content">
                <h3 class="counter" data-target="{{ total_schools }}">0</h3>
                <p class="label">Branches</p>
            </div>
            <canvas class="sparkline" id="sparklineSchools"></canvas>
        </div>
        
        <div class="stat-card stat-staff">
            <div class="card-decoration"></div>
            <div class="stat-icon">üë•</div>
            <div class="stat-content">
                <h3 class="counter" data-target="{{ total_staff }}">0</h3>
                <p class="label">Total Staff</p>
            </div>
            <canvas class="sparkline" id="sparklineStaff"></canvas>
        </div>
        
        <div class="stat-card stat-present">
            <div class="card-decoration"></div>
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-content">
                <h3 class="counter" data-target="{{ today_present }}">0</h3>
                <p class="label">Present Today</p>
            </div>
            <canvas class="sparkline" id="sparklinePresent"></canvas>
        </div>
        
        <div class="stat-card stat-late">
            <div class="card-decoration"></div>
            <div class="stat-icon">‚è∞</div>
            <div class="stat-content">
                <h3 class="counter" data-target="{{ today_late }}">0</h3>
                <p class="label">Late Today</p>
            </div>
            <canvas class="sparkline" id="sparklineLate"></canvas>
        </div>
        
        <div class="stat-card stat-absent">
            <div class="card-decoration"></div>
            <div class="stat-icon">‚ùå</div>
            <div class="stat-content">
                <h3 class="counter" data-target="{{ today_absent }}">0</h3>
                <p class="label">Absent Today</p>
            </div>
            <canvas class="sparkline" id="sparklineAbsent"></canvas>
        </div>
    </div>

    <!-- Branch Statistics Table -->
    <div class="branch-stats-container">
        <div class="section-header">
            <h2>üìç Branch Statistics</h2>
            <span class="today-date">{{ today_date }}</span>
        </div>
        <div class="table-wrapper">
            <table class="branch-table">
                <thead>
                    <tr>
                        <th>Branch Name</th>
                        <th>Total Staff</th>
                        <th>Present</th>
                        <th>Late</th>
                        <th>Absent</th>
                        <th>Attendance Rate</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="branchTableBody">
                    {% for branch in branch_stats %}
                    <tr class="branch-row" data-branch-id="{{ branch.id }}">
                        <td class="branch-name">
                            <span class="branch-icon">üèõÔ∏è</span>
                            {{ branch.name }}
                        </td>
                        <td>{{ branch.total_staff }}</td>
                        <td class="present-count">{{ branch.present }}</td>
                        <td class="late-count">{{ branch.late }}</td>
                        <td class="absent-count">{{ branch.absent }}</td>
                        <td>
                            <div class="attendance-rate">
                                <div class="rate-bar">
                                    <div class="rate-fill" style="width: {{ branch.attendance_rate }}%"></div>
                                </div>
                                <span class="rate-text">{{ branch.attendance_rate }}%</span>
                            </div>
                        </td>
                        <td class="expand-cell">
                            <span class="expand-arrow">‚Ä∫</span>
                        </td>
                    </tr>
                    <tr class="staff-expansion-row" data-branch-id="{{ branch.id }}">
                        <td colspan="7">
                            <div class="staff-expansion-content">
                                <div class="staff-list-loader">
                                    <div class="loader-spinner"></div>
                                    <span>Loading staff...</span>
                                </div>
                                <div class="staff-list"></div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
/* ============================================
   DASHBOARD CORE STYLES
   ============================================ */
.dashboard-container {
    padding: 20px;
    max-width: 1600px;
    margin: 0 auto;
    min-height: 100vh;
}

/* ============================================
   HEADER SECTION
   ============================================ */
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 20px 25px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    color: white;
    box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
}

.header-left h1 {
    margin: 0 0 10px 0;
    font-size: 1.8rem;
    font-weight: 700;
}

.header-left,
.header-center,
.header-right {
    flex: 1;
}

.header-center {
    display: flex;
    justify-content: center;
}

.header-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
}

/* Search Box */
.search-container {
    position: relative;
}

.staff-search {
    padding: 10px 15px;
    border: none;
    border-radius: 25px;
    width: 220px;
    font-size: 0.9rem;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    transition: all 0.3s ease;
}

.staff-search::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

.staff-search:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.3);
    width: 260px;
}

.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    margin-top: 8px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.search-results.active {
    display: block;
}

.search-result-item {
    padding: 12px 15px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: background 0.2s;
    color: #333;
}

.search-result-item:hover {
    background: #f5f5f5;
}

.search-result-item:first-child {
    border-radius: 12px 12px 0 0;
}

.search-result-item:last-child {
    border-radius: 0 0 12px 12px;
}

.result-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.9rem;
    color: white;
}

.result-info {
    flex: 1;
}

.result-name {
    font-weight: 600;
    font-size: 0.95rem;
}

.result-details {
    font-size: 0.8rem;
    color: #666;
}

.result-status {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
}

.result-status.signed-in {
    background: #d4edda;
    color: #155724;
}

.result-status.late {
    background: #fff3cd;
    color: #856404;
}

.result-status.absent {
    background: #f8d7da;
    color: #721c24;
}

.no-results {
    padding: 20px;
    text-align: center;
    color: #666;
}

/* First Check-in Card */
.first-checkin-card {
    display: flex;
    align-items: center;
    gap: 12px;
    background: rgba(255, 255, 255, 0.15);
    padding: 12px 20px;
    border-radius: 12px;
    backdrop-filter: blur(10px);
}

.first-checkin-icon {
    font-size: 1.8rem;
}

.first-checkin-info {
    display: flex;
    flex-direction: column;
}

.first-checkin-label {
    font-size: 0.7rem;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.first-checkin-name {
    font-weight: 700;
    font-size: 1rem;
}

.first-checkin-details {
    font-size: 0.8rem;
    opacity: 0.9;
}

.first-checkin-time {
    font-size: 1.4rem;
    font-weight: 700;
    font-family: 'Courier New', monospace;
    background: rgba(255, 255, 255, 0.2);
    padding: 5px 12px;
    border-radius: 8px;
}

/* Greeting */
.greeting {
    font-size: 1rem;
    opacity: 0.9;
}

/* Clock Styles */
.clock-container {
    display: flex;
    align-items: center;
    gap: 15px;
}

.analog-clock {
    width: 60px;
    height: 60px;
}

.clock-face {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    position: relative;
    backdrop-filter: blur(10px);
}

.clock-hand {
    position: absolute;
    bottom: 50%;
    left: 50%;
    transform-origin: bottom center;
    border-radius: 4px;
}

.hour-hand {
    width: 3px;
    height: 16px;
    background: white;
    margin-left: -1.5px;
}

.minute-hand {
    width: 2px;
    height: 22px;
    background: rgba(255, 255, 255, 0.9);
    margin-left: -1px;
}

.second-hand {
    width: 1px;
    height: 25px;
    background: #ffd700;
    margin-left: -0.5px;
}

.clock-center {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 8px;
    height: 8px;
    background: #ffd700;
    border-radius: 50%;
    transform: translate(-50%, -50%);
}

.digital-clock {
    font-family: 'Courier New', monospace;
    font-size: 1.4rem;
    font-weight: 700;
    background: rgba(255, 255, 255, 0.15);
    padding: 8px 15px;
    border-radius: 8px;
}

/* ============================================
   LIVE TICKER
   ============================================ */
.live-ticker-container {
    display: flex;
    align-items: center;
    gap: 15px;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    padding: 12px 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    overflow: hidden;
}

.live-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #e74c3c;
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    white-space: nowrap;
}

.live-dot {
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
}

.ticker-wrapper {
    flex: 1;
    overflow: hidden;
}

.ticker-content {
    display: flex;
    gap: 50px;
    animation: scroll 30s linear infinite;
    white-space: nowrap;
}

.ticker-item {
    color: #a0a0a0;
    font-size: 0.9rem;
}

.ticker-item .name {
    color: #4fc3f7;
    font-weight: 600;
}

.ticker-item .time {
    color: #81c784;
}

.ticker-item .branch {
    color: #ffb74d;
}

@keyframes scroll {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
}

/* ============================================
   STATS CARDS
   ============================================ */
.stats-grid {
    display: flex;
    gap: 15px;
    margin-bottom: 25px;
}

.stat-card {
    flex: 1;
    min-width: 0;
    aspect-ratio: 1;
    max-width: 180px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 15px;
    position: relative;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.stat-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
}

.stat-card:hover .card-decoration {
    transform: scale(1.3);
    opacity: 0.25;
}

.card-decoration {
    position: absolute;
    top: -30px;
    right: -30px;
    width: 100px;
    height: 100px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 50%;
    transition: all 0.4s ease;
}

.stat-icon {
    font-size: 1.5rem;
    margin-bottom: 5px;
}

.stat-content {
    position: relative;
    z-index: 1;
}

.stat-content h3 {
    font-size: 2rem;
    font-weight: 700;
    color: white;
    margin: 0;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
}

.stat-content .label {
    font-size: 0.8rem;
    color: white;
    opacity: 1;
    font-weight: 700;
    margin: 3px 0 0 0;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
}

.sparkline {
    width: 100%;
    height: 35px;
    margin-top: auto;
}

/* Card Color Variations */
.stat-schools {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.stat-staff {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.stat-present {
    background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
}

.stat-late {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.stat-late .stat-content h3 {
    text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
}

.stat-late .stat-content .label {
    text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.3);
}

.stat-absent {
    background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%);
}

.stat-absent .stat-content h3 {
    text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
}

.stat-absent .stat-content .label {
    text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.3);
}

/* ============================================
   BRANCH STATISTICS TABLE
   ============================================ */
.branch-stats-container {
    background: white;
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.section-header h2 {
    margin: 0;
    font-size: 1.3rem;
    color: #333;
}

.today-date {
    color: #666;
    font-size: 0.9rem;
}

.table-wrapper {
    overflow-x: auto;
}

.branch-table {
    width: 100%;
    border-collapse: collapse;
}

.branch-table th {
    text-align: left;
    padding: 12px 15px;
    background: #f8f9fa;
    color: #555;
    font-weight: 600;
    font-size: 0.85rem;
    border-bottom: 2px solid #eee;
}

.branch-table td {
    padding: 15px;
    border-bottom: 1px solid #eee;
    color: #333;
}

.branch-row {
    cursor: pointer;
    transition: all 0.3s ease;
}

.branch-row:hover {
    background: #f8f9ff;
}

.branch-row.expanded {
    background: #f0f4ff;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
}

.branch-name {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
}

.branch-icon {
    font-size: 1.2rem;
}

.present-count {
    color: #27ae60;
    font-weight: 600;
}

.late-count {
    color: #e67e22;
    font-weight: 600;
}

.absent-count {
    color: #e74c3c;
    font-weight: 600;
}

.attendance-rate {
    display: flex;
    align-items: center;
    gap: 10px;
}

.rate-bar {
    flex: 1;
    height: 8px;
    background: #eee;
    border-radius: 4px;
    overflow: hidden;
    max-width: 120px;
}

.rate-fill {
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 4px;
    transition: width 0.6s ease;
}

.rate-text {
    font-weight: 600;
    font-size: 0.9rem;
    color: #555;
    min-width: 45px;
}

/* Expand Arrow */
.expand-cell {
    width: 40px;
    text-align: center;
}

.expand-arrow {
    display: inline-block;
    font-size: 1.3rem;
    color: #999;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    font-weight: bold;
}

.branch-row:hover .expand-arrow {
    color: #667eea;
}

.branch-row.expanded .expand-arrow {
    transform: rotate(90deg);
    color: #667eea;
}

/* ============================================
   STAFF EXPANSION ROW
   ============================================ */
.staff-expansion-row {
    display: none;
}

.staff-expansion-row.active {
    display: table-row;
}

.staff-expansion-row td {
    padding: 0;
    background: #f8f9ff;
    border-bottom: 2px solid #667eea;
}

.staff-expansion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
                padding 0.3s ease;
}

.staff-expansion-row.active .staff-expansion-content {
    max-height: 500px;
    padding: 20px;
}

/* Staff List Loader */
.staff-list-loader {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 30px;
    color: #666;
}

.staff-list-loader.hidden {
    display: none;
}

.loader-spinner {
    width: 24px;
    height: 24px;
    border: 3px solid #eee;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Staff List */
.staff-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px;
}

.staff-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    opacity: 0;
    transform: translateY(10px);
    animation: staffFadeIn 0.4s ease forwards;
}

@keyframes staffFadeIn {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.staff-avatar {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.95rem;
    color: white;
    flex-shrink: 0;
}

.staff-info {
    flex: 1;
    min-width: 0;
}

.staff-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.staff-department {
    font-size: 0.8rem;
    color: #888;
}

.staff-status {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 3px;
}

.status-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.status-badge.signed-in {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    color: #155724;
}

.status-badge.late {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
    color: #856404;
}

.status-badge.absent {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    color: #721c24;
}

.checkin-time {
    font-size: 0.8rem;
    color: #666;
    font-family: 'Courier New', monospace;
}

/* Status dot pulse effect */
.status-badge.signed-in::before,
.status-badge.late::before,
.status-badge.absent::before {
    content: '';
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin-right: 5px;
    animation: statusPulse 2s ease-in-out infinite;
}

.status-badge.signed-in::before {
    background: #28a745;
}

.status-badge.late::before {
    background: #ffc107;
}

.status-badge.absent::before {
    background: #dc3545;
}

@keyframes statusPulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
}

/* Empty State */
.staff-empty {
    text-align: center;
    padding: 30px;
    color: #888;
    font-size: 0.95rem;
}

.staff-empty-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ============================================
    // CLOCK FUNCTIONALITY
    // ============================================
    function updateClock() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const seconds = now.getSeconds();
        
        // Analog clock
        const hourDeg = (hours % 12) * 30 + minutes * 0.5;
        const minuteDeg = minutes * 6;
        const secondDeg = seconds * 6;
        
        document.getElementById('hourHand').style.transform = `rotate(${hourDeg}deg)`;
        document.getElementById('minuteHand').style.transform = `rotate(${minuteDeg}deg)`;
        document.getElementById('secondHand').style.transform = `rotate(${secondDeg}deg)`;
        
        // Digital clock
        const timeString = [hours, minutes, seconds]
            .map(n => n.toString().padStart(2, '0'))
            .join(':');
        document.getElementById('digitalClock').textContent = timeString;
        
        // Greeting
        let greeting = 'Good evening';
        if (hours < 12) greeting = 'Good morning';
        else if (hours < 17) greeting = 'Good afternoon';
        document.getElementById('greeting').textContent = greeting;
    }
    
    updateClock();
    setInterval(updateClock, 1000);

    // ============================================
    // ANIMATED COUNTERS
    // ============================================
    function animateCounters() {
        const counters = document.querySelectorAll('.counter');
        counters.forEach(counter => {
            const target = parseInt(counter.getAttribute('data-target'));
            const duration = 2000;
            const startTime = performance.now();
            
            function updateCounter(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(easeOut * target);
                counter.textContent = current;
                
                if (progress < 1) {
                    requestAnimationFrame(updateCounter);
                } else {
                    counter.textContent = target;
                }
            }
            
            requestAnimationFrame(updateCounter);
        });
    }
    
    animateCounters();

    // ============================================
    // SPARKLINE CHARTS
    // ============================================
    function createSparkline(canvasId, color, data) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map((_, i) => i),
                datasets: [{
                    data: data,
                    borderColor: 'rgba(255,255,255,0.8)',
                    borderWidth: 2,
                    fill: true,
                    backgroundColor: 'rgba(255,255,255,0.1)',
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { display: false }
                },
                animation: {
                    duration: 1500,
                    easing: 'easeOutQuart'
                }
            }
        });
    }
    
    // Generate sample sparkline data
    const generateData = () => Array.from({length: 7}, () => Math.floor(Math.random() * 50) + 20);
    
    createSparkline('sparklineSchools', '#667eea', generateData());
    createSparkline('sparklineStaff', '#11998e', generateData());
    createSparkline('sparklinePresent', '#2193b0', generateData());
    createSparkline('sparklineLate', '#f093fb', generateData());
    createSparkline('sparklineAbsent', '#fc4a1a', generateData());

    // ============================================
    // DASHBOARD AUTO-REFRESH
    // ============================================
    function refreshDashboard() {
        fetch('/api/dashboard-stats')
            .then(response => response.json())
            .then(data => {
                // Update counters
                updateCounterValue('.stat-schools .counter', data.total_schools);
                updateCounterValue('.stat-staff .counter', data.total_staff);
                updateCounterValue('.stat-present .counter', data.today_attendance);
                updateCounterValue('.stat-late .counter', data.late_today);
                updateCounterValue('.stat-absent .counter', data.absent_today);
                
                // Update first check-in
                if (data.first_checkin) {
                    document.getElementById('firstCheckinName').textContent = data.first_checkin.name;
                    document.getElementById('firstCheckinDetails').textContent = 
                        `${data.first_checkin.branch} ‚Ä¢ ${data.first_checkin.department}`;
                    document.getElementById('firstCheckinTime').textContent = data.first_checkin.time;
                } else {
                    document.getElementById('firstCheckinName').textContent = 'No check-ins yet';
                    document.getElementById('firstCheckinDetails').textContent = '---';
                    document.getElementById('firstCheckinTime').textContent = '--:--';
                }
                
                // Update ticker
                if (data.recent_activity && data.recent_activity.length > 0) {
                    updateTicker(data.recent_activity);
                }
            })
            .catch(error => console.error('Error refreshing dashboard:', error));
    }
    
    function updateCounterValue(selector, newValue) {
        const counter = document.querySelector(selector);
        if (counter) {
            const currentValue = parseInt(counter.textContent);
            if (currentValue !== newValue) {
                counter.setAttribute('data-target', newValue);
                animateSingleCounter(counter, currentValue, newValue);
            }
        }
    }
    
    function animateSingleCounter(counter, from, to) {
        const duration = 1000;
        const startTime = performance.now();
        
        function update(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easeOut = 1 - Math.pow(1 - progress, 3);
            const current = Math.floor(from + (to - from) * easeOut);
            counter.textContent = current;
            
            if (progress < 1) {
                requestAnimationFrame(update);
            } else {
                counter.textContent = to;
            }
        }
        
        requestAnimationFrame(update);
    }
    
    function updateTicker(activities) {
        const ticker = document.getElementById('tickerContent');
        if (!ticker || activities.length === 0) return;
        
        const tickerHTML = activities.map(a => 
            `<span class="ticker-item">
                <span class="name">${a.name}</span> checked in at 
                <span class="time">${a.time}</span> ‚Ä¢ 
                <span class="branch">${a.branch}</span>
            </span>`
        ).join('');
        
        ticker.innerHTML = tickerHTML + tickerHTML;
    }
    
    // Refresh every 15 seconds
    setInterval(refreshDashboard, 15000);
    refreshDashboard(); // Initial load

    // ============================================
    // STAFF SEARCH
    // ============================================
    const searchInput = document.getElementById('staffSearch');
    const searchResults = document.getElementById('searchResults');
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            searchResults.classList.remove('active');
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`/api/search-staff?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        searchResults.innerHTML = '<div class="no-results">No staff found</div>';
                    } else {
                        searchResults.innerHTML = data.map(staff => `
                            <div class="search-result-item">
                                <div class="result-avatar" style="background: ${staff.color}">${staff.initials}</div>
                                <div class="result-info">
                                    <div class="result-name">${staff.name}</div>
                                    <div class="result-details">${staff.branch} ‚Ä¢ ${staff.department}</div>
                                </div>
                                <span class="result-status ${staff.status}">${staff.status_text}</span>
                            </div>
                        `).join('');
                    }
                    searchResults.classList.add('active');
                })
                .catch(error => {
                    console.error('Search error:', error);
                    searchResults.classList.remove('active');
                });
        }, 300);
    });
    
    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.remove('active');
        }
    });
    
    // Keyboard shortcut Ctrl+K
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'k') {
            e.preventDefault();
            searchInput.focus();
        }
    });

    // ============================================
    // EXPANDABLE BRANCH ROWS
    // ============================================
    const branchRows = document.querySelectorAll('.branch-row');
    let currentExpandedBranch = null;
    
    branchRows.forEach(row => {
        row.addEventListener('click', function() {
            const branchId = this.getAttribute('data-branch-id');
            const expansionRow = document.querySelector(`.staff-expansion-row[data-branch-id="${branchId}"]`);
            
            // If clicking the same row, just collapse it
            if (currentExpandedBranch === branchId) {
                collapseRow(this, expansionRow);
                currentExpandedBranch = null;
                return;
            }
            
            // Collapse any currently expanded row
            if (currentExpandedBranch) {
                const prevRow = document.querySelector(`.branch-row[data-branch-id="${currentExpandedBranch}"]`);
                const prevExpansion = document.querySelector(`.staff-expansion-row[data-branch-id="${currentExpandedBranch}"]`);
                if (prevRow && prevExpansion) {
                    collapseRow(prevRow, prevExpansion);
                }
            }
            
            // Expand the clicked row
            expandRow(this, expansionRow, branchId);
            currentExpandedBranch = branchId;
        });
    });
    
    function expandRow(row, expansionRow, branchId) {
        row.classList.add('expanded');
        expansionRow.classList.add('active');
        
        // Show loader and fetch staff data
        const loader = expansionRow.querySelector('.staff-list-loader');
        const staffList = expansionRow.querySelector('.staff-list');
        
        loader.classList.remove('hidden');
        staffList.innerHTML = '';
        
        // Fetch staff data for this branch
        fetch(`/api/branch-staff/${branchId}`)
            .then(response => response.json())
            .then(data => {
                loader.classList.add('hidden');
                
                if (data.staff && data.staff.length > 0) {
                    staffList.innerHTML = data.staff.map((staff, index) => `
                        <div class="staff-item" style="animation-delay: ${index * 0.05}s">
                            <div class="staff-avatar" style="background: ${staff.color}">${staff.initials}</div>
                            <div class="staff-info">
                                <div class="staff-name">${staff.name}</div>
                                <div class="staff-department">${staff.department}</div>
                            </div>
                            <div class="staff-status">
                                <span class="status-badge ${staff.status}">${staff.status_text}</span>
                                ${staff.checkin_time ? `<span class="checkin-time">${staff.checkin_time}</span>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    staffList.innerHTML = `
                        <div class="staff-empty">
                            <div class="staff-empty-icon">üë•</div>
                            <p>No staff assigned to this branch</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error fetching staff:', error);
                loader.classList.add('hidden');
                staffList.innerHTML = `
                    <div class="staff-empty">
                        <div class="staff-empty-icon">‚ö†Ô∏è</div>
                        <p>Error loading staff data</p>
                    </div>
                `;
            });
    }
    
    function collapseRow(row, expansionRow) {
        row.classList.remove('expanded');
        
        // Wait for animation before hiding
        const content = expansionRow.querySelector('.staff-expansion-content');
        content.style.maxHeight = '0';
        content.style.padding = '0 20px';
        
        setTimeout(() => {
            expansionRow.classList.remove('active');
            content.style.maxHeight = '';
            content.style.padding = '';
        }, 500);
    }
});
</script>
{% endblock %}
