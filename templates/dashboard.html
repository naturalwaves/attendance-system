{% extends 'base.html' %}

{% block title %}Dashboard - Attendance System{% endblock %}

{% block content %}
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
        min-height: 100vh;
        margin: 0;
    }

    /* Clock Styles */
    .clock-container {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    .analog-clock {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(145deg, #ffffff, #e6e6e6);
        box-shadow: 
            0 4px 15px rgba(0,0,0,0.1),
            inset 0 2px 4px rgba(255,255,255,0.9);
        position: relative;
    }
    
    .clock-face {
        width: 100%;
        height: 100%;
        position: relative;
    }
    
    .clock-center {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 8px;
        height: 8px;
        background: #667eea;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
    }
    
    .hand {
        position: absolute;
        bottom: 50%;
        left: 50%;
        transform-origin: bottom center;
        border-radius: 2px;
    }
    
    .hour-hand {
        width: 3px;
        height: 22px;
        background: #333;
        margin-left: -1.5px;
    }
    
    .minute-hand {
        width: 2px;
        height: 28px;
        background: #666;
        margin-left: -1px;
    }
    
    .second-hand {
        width: 1px;
        height: 32px;
        background: #667eea;
        margin-left: -0.5px;
    }
    
    .clock-marks {
        position: absolute;
        width: 100%;
        height: 100%;
    }
    
    .mark {
        position: absolute;
        background: #999;
    }
    
    .mark-12, .mark-6 {
        width: 2px;
        height: 8px;
        left: 50%;
        margin-left: -1px;
    }
    
    .mark-12 { top: 6px; }
    .mark-6 { bottom: 6px; }
    
    .mark-3, .mark-9 {
        width: 8px;
        height: 2px;
        top: 50%;
        margin-top: -1px;
    }
    
    .mark-3 { right: 6px; }
    .mark-9 { left: 6px; }
    
    .digital-clock {
        text-align: left;
    }
    
    .time-display {
        font-size: 1.8rem;
        font-weight: 700;
        color: #333;
        letter-spacing: 1px;
    }
    
    .date-display {
        font-size: 0.85rem;
        color: #666;
        margin-top: 2px;
    }

    /* Dashboard Header */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .greeting h1 {
        font-size: 1.8rem;
        color: #333;
        margin: 0;
    }

    .greeting p {
        color: #666;
        margin: 5px 0 0 0;
    }

    /* Live Activity Ticker */
    .activity-ticker-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 15px 20px;
        margin-bottom: 30px;
        overflow: hidden;
        position: relative;
    }

    .ticker-label {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255,255,255,0.2);
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        color: white;
        text-transform: uppercase;
        letter-spacing: 1px;
        z-index: 2;
    }

    .ticker-wrapper {
        margin-left: 100px;
        overflow: hidden;
        mask-image: linear-gradient(90deg, transparent, black 10%, black 90%, transparent);
        -webkit-mask-image: linear-gradient(90deg, transparent, black 10%, black 90%, transparent);
    }

    .ticker-content {
        display: flex;
        gap: 50px;
        animation: ticker-scroll 30s linear infinite;
        width: max-content;
    }

    .ticker-content:hover {
        animation-play-state: paused;
    }

    @keyframes ticker-scroll {
        0% { transform: translateX(0); }
        100% { transform: translateX(-50%); }
    }

    .ticker-item {
        display: flex;
        align-items: center;
        gap: 10px;
        color: white;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .ticker-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .ticker-dot.check-in { background: #4ade80; }
    .ticker-dot.check-out { background: #f87171; }
    .ticker-dot.late { background: #fbbf24; }

    .ticker-time {
        opacity: 0.8;
        font-size: 0.8rem;
    }

    /* Stats Cards */
    .stats-grid {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .stat-card {
        flex: 1;
        min-width: 180px;
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        border-radius: 16px 16px 0 0;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 30px rgba(0,0,0,0.12);
    }

    .stat-card.branches::before { background: linear-gradient(90deg, #667eea, #764ba2); }
    .stat-card.staff::before { background: linear-gradient(90deg, #3b82f6, #1d4ed8); }
    .stat-card.present::before { background: linear-gradient(90deg, #10b981, #059669); }
    .stat-card.late::before { background: linear-gradient(90deg, #f59e0b, #d97706); }
    .stat-card.absent::before { background: linear-gradient(90deg, #ef4444, #dc2626); }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 16px;
    }

    .stat-card.branches .stat-icon { background: rgba(102, 126, 234, 0.1); }
    .stat-card.staff .stat-icon { background: rgba(59, 130, 246, 0.1); }
    .stat-card.present .stat-icon { background: rgba(16, 185, 129, 0.1); }
    .stat-card.late .stat-icon { background: rgba(245, 158, 11, 0.1); }
    .stat-card.absent .stat-icon { background: rgba(239, 68, 68, 0.1); }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
        line-height: 1;
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #888;
        font-weight: 500;
    }

    .stat-card.late .stat-label {
        color: #666;
        font-weight: 700;
        text-shadow: 0 0 1px rgba(0,0,0,0.1);
    }

    .stat-sparkline {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 30px;
        opacity: 0.5;
    }

    /* First Check-in Card */
    .first-checkin-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 24px;
        color: white;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .first-checkin-icon {
        width: 60px;
        height: 60px;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
    }

    .first-checkin-info h3 {
        margin: 0;
        font-size: 1.1rem;
        opacity: 0.9;
    }

    .first-checkin-info .name {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 5px 0;
    }

    .first-checkin-info .time {
        opacity: 0.8;
        font-size: 0.9rem;
    }

    /* Search Box */
    .search-container {
        position: relative;
        margin-bottom: 30px;
    }

    .search-box {
        width: 100%;
        max-width: 400px;
        padding: 14px 20px 14px 50px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
    }

    .search-box:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .search-icon {
        position: absolute;
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        font-size: 1.1rem;
    }

    .search-shortcut {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        background: #f0f0f0;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.75rem;
        color: #666;
        font-family: monospace;
    }

    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-width: 400px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        margin-top: 8px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 100;
        display: none;
    }

    .search-results.active {
        display: block;
    }

    .search-result-item {
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .search-result-item:hover {
        background: #f5f5f5;
    }

    .search-result-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .search-result-info {
        flex: 1;
    }

    .search-result-name {
        font-weight: 600;
        color: #333;
    }

    .search-result-details {
        font-size: 0.8rem;
        color: #888;
    }

    /* Branch Statistics Table */
    .section-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        margin-bottom: 30px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-title i {
        color: #667eea;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 14px 16px;
        text-align: left;
        border-bottom: 1px solid #f0f0f0;
    }

    .data-table th {
        font-weight: 600;
        color: #666;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: #fafafa;
    }

    .data-table tr:hover {
        background: #fafafa;
    }

    .branch-name {
        font-weight: 600;
        color: #333;
    }

    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .badge-present { background: #d1fae5; color: #059669; }
    .badge-late { background: #fef3c7; color: #d97706; }
    .badge-absent { background: #fee2e2; color: #dc2626; }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    /* Quick Actions */
    .quick-actions {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .quick-action-btn {
        padding: 14px 24px;
        border: none;
        border-radius: 12px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
    }

    .quick-action-btn.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .quick-action-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .quick-action-btn.secondary {
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
    }

    .quick-action-btn.secondary:hover {
        background: #667eea;
        color: white;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .dashboard-header {
            flex-direction: column;
            text-align: center;
        }

        .stats-grid {
            flex-direction: column;
        }

        .stat-card {
            min-width: 100%;
        }

        .first-checkin-card {
            flex-direction: column;
            text-align: center;
        }

        .ticker-wrapper {
            margin-left: 0;
        }

        .ticker-label {
            position: relative;
            left: auto;
            top: auto;
            transform: none;
            margin-bottom: 10px;
            display: inline-block;
        }

        .activity-ticker-container {
            text-align: center;
        }
    }

    /* Counter Animation */
    @keyframes countUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .stat-number {
        animation: countUp 0.5s ease-out forwards;
    }
</style>

<div class="dashboard-header">
    <div class="greeting">
        <h1 id="greeting-text">Good morning, {{ current_user.username }}!</h1>
        <p id="greeting-subtitle">Here's your attendance overview for today</p>
    </div>
    <div class="clock-container">
        <div class="analog-clock">
            <div class="clock-face">
                <div class="clock-marks">
                    <div class="mark mark-12"></div>
                    <div class="mark mark-3"></div>
                    <div class="mark mark-6"></div>
                    <div class="mark mark-9"></div>
                </div>
                <div class="hand hour-hand" id="hour-hand"></div>
                <div class="hand minute-hand" id="minute-hand"></div>
                <div class="hand second-hand" id="second-hand"></div>
                <div class="clock-center"></div>
            </div>
        </div>
        <div class="digital-clock">
            <div class="time-display" id="digital-time">00:00:00</div>
            <div class="date-display" id="digital-date">Loading...</div>
        </div>
    </div>
</div>

<!-- Live Activity Ticker -->
<div class="activity-ticker-container">
    <span class="ticker-label">üî¥ Live</span>
    <div class="ticker-wrapper">
        <div class="ticker-content" id="ticker-content">
            {% if recent_activity %}
                {% for activity in recent_activity %}
                    {% for activity in recent_activity %}
                    <div class="ticker-item">
                        <span class="ticker-dot {{ 'check-in' if activity.check_in_time and not activity.check_out_time else 'check-out' if activity.check_out_time else 'late' }}"></span>
                        <span>{{ activity.staff.name }}</span>
                        <span class="ticker-time">
                            {% if activity.check_out_time %}
                                out {{ activity.check_out_time.strftime('%H:%M') }}
                            {% else %}
                                in {{ activity.check_in_time.strftime('%H:%M') }}
                            {% endif %}
                        </span>
                    </div>
                {% endfor %}
                {% endfor %}
            {% else %}
                <div class="ticker-item">
                    <span class="ticker-dot check-in"></span>
                    <span>No activity yet today</span>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card branches">
        <div class="stat-icon">üè¢</div>
        <div class="stat-number" data-count="{{ schools|length }}">{{ schools|length }}</div>
        <div class="stat-label">Total Branches</div>
        <canvas class="stat-sparkline" id="branches-sparkline"></canvas>
    </div>
    <div class="stat-card staff">
        <div class="stat-icon">üë•</div>
        <div class="stat-number" data-count="{{ total_staff }}">{{ total_staff }}</div>
        <div class="stat-label">Total Staff</div>
        <canvas class="stat-sparkline" id="staff-sparkline"></canvas>
    </div>
    <div class="stat-card present">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-number" data-count="{{ present_today }}">{{ present_today }}</div>
        <div class="stat-label">Present Today</div>
        <canvas class="stat-sparkline" id="present-sparkline"></canvas>
    </div>
    <div class="stat-card late">
        <div class="stat-icon">‚è∞</div>
        <div class="stat-number" data-count="{{ late_today }}">{{ late_today }}</div>
        <div class="stat-label">Late Today</div>
        <canvas class="stat-sparkline" id="late-sparkline"></canvas>
    </div>
    <div class="stat-card absent">
        <div class="stat-icon">‚ùå</div>
        <div class="stat-number" data-count="{{ absent_today }}">{{ absent_today }}</div>
        <div class="stat-label">Absent Today</div>
        <canvas class="stat-sparkline" id="absent-sparkline"></canvas>
    </div>
</div>

<!-- First Check-in Card -->
<div class="first-checkin-card" id="first-checkin-card">
    <div class="first-checkin-icon">üèÜ</div>
    <div class="first-checkin-info">
        <h3>First Check-in Today</h3>
        {% if first_checkin %}
            <div class="name">{{ first_checkin.staff.name }}</div>
            <div class="time">Checked in at {{ first_checkin.check_in_time.strftime('%H:%M') }} ¬∑ {{ first_checkin.school.name }}</div>
        {% else %}
            <div class="name">No check-ins yet</div>
            <div class="time">Waiting for first arrival...</div>
        {% endif %}
    </div>
</div>

<!-- Quick Staff Search -->
<div class="search-container">
    <i class="fas fa-search search-icon">üîç</i>
    <input type="text" class="search-box" id="staff-search" placeholder="Search staff by name or ID..." autocomplete="off">
    <span class="search-shortcut">Ctrl+K</span>
    <div class="search-results" id="search-results"></div>
</div>

<!-- Branch Statistics Table -->
<div class="section-card">
    <div class="section-header">
        <h2 class="section-title">
            <i>üìä</i> Branch Statistics
        </h2>
    </div>
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Branch Name</th>
                    <th>Total Staff</th>
                    <th>Present</th>
                    <th>Late</th>
                    <th>Absent</th>
                    <th>Attendance Rate</th>
                </tr>
            </thead>
            <tbody>
                {% for school in schools %}
                <tr>
                    <td class="branch-name">{{ school.name }}</td>
                    <td>{{ school.staff|length }}</td>
                    <td><span class="status-badge badge-present">{{ school.present_count }}</span></td>
                    <td><span class="status-badge badge-late">{{ school.late_count }}</span></td>
                    <td><span class="status-badge badge-absent">{{ school.absent_count }}</span></td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ school.attendance_rate }}%"></div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Quick Actions -->
<div class="section-card">
    <div class="section-header">
        <h2 class="section-title">
            <i>‚ö°</i> Quick Actions
        </h2>
    </div>
    <div class="quick-actions">
        <a href="{{ url_for('add_staff') }}" class="quick-action-btn primary">
            <span>‚ûï</span> Add New Staff
        </a>
        <a href="{{ url_for('attendance_report') }}" class="quick-action-btn secondary">
            <span>üìã</span> View Reports
        </a>
        <a href="{{ url_for('analytics') }}" class="quick-action-btn secondary">
            <span>üìà</span> Analytics
        </a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Update greeting based on time of day
    function updateGreeting() {
        const hour = new Date().getHours();
        const greetingText = document.getElementById('greeting-text');
        let greeting;
        
        if (hour < 12) {
            greeting = 'Good morning';
        } else if (hour < 17) {
            greeting = 'Good afternoon';
        } else {
            greeting = 'Good evening';
        }
        
        greetingText.textContent = `${greeting}, {{ current_user.username }}!`;
    }

    // Clock functionality
    function updateClock() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const seconds = now.getSeconds();

        // Analog clock
        const hourDeg = (hours % 12) * 30 + minutes * 0.5;
        const minuteDeg = minutes * 6;
        const secondDeg = seconds * 6;

        document.getElementById('hour-hand').style.transform = `rotate(${hourDeg}deg)`;
        document.getElementById('minute-hand').style.transform = `rotate(${minuteDeg}deg)`;
        document.getElementById('second-hand').style.transform = `rotate(${secondDeg}deg)`;

        // Digital clock
        const timeString = now.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit',
            hour12: true 
        });
        const dateString = now.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });

        document.getElementById('digital-time').textContent = timeString;
        document.getElementById('digital-date').textContent = dateString;
    }

    // Counter animation
    function animateCounters() {
        const counters = document.querySelectorAll('.stat-number');
        counters.forEach(counter => {
            const target = parseInt(counter.getAttribute('data-count'));
            const duration = 2000;
            const start = 0;
            const startTime = performance.now();

            function updateCounter(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(start + (target - start) * easeOut);
                
                counter.textContent = current;
                
                if (progress < 1) {
                    requestAnimationFrame(updateCounter);
                } else {
                    counter.textContent = target;
                }
            }

            requestAnimationFrame(updateCounter);
        });
    }

    // Sparkline charts
    function createSparklines() {
        const sparklineConfig = {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { display: false }
                },
                elements: {
                    point: { radius: 0 },
                    line: { tension: 0.4, borderWidth: 2 }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeOutQuart'
                }
            }
        };

        const colors = {
            branches: '#667eea',
            staff: '#3b82f6',
            present: '#10b981',
            late: '#f59e0b',
            absent: '#ef4444'
        };

        Object.keys(colors).forEach(key => {
            const canvas = document.getElementById(`${key}-sparkline`);
            if (canvas) {
                new Chart(canvas, {
                    ...sparklineConfig,
                    data: {
                        labels: ['', '', '', '', '', '', ''],
                        datasets: [{
                            data: Array.from({length: 7}, () => Math.floor(Math.random() * 50) + 25),
                            borderColor: colors[key],
                            fill: false
                        }]
                    }
                });
            }
        });
    }

    // Staff search functionality
    const searchBox = document.getElementById('staff-search');
    const searchResults = document.getElementById('search-results');

    searchBox.addEventListener('input', async function() {
        const query = this.value.trim();
        if (query.length < 2) {
            searchResults.classList.remove('active');
            return;
        }

        try {
            const response = await fetch(`/api/search-staff?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (data.length > 0) {
                searchResults.innerHTML = data.map(staff => `
                    <div class="search-result-item" onclick="window.location.href='/staff/${staff.id}'">
                        <div class="search-result-avatar">${staff.initials}</div>
                        <div class="search-result-info">
                            <div class="search-result-name">${staff.name}</div>
                            <div class="search-result-details">${staff.department} ¬∑ ${staff.school}</div>
                        </div>
                    </div>
                `).join('');
                searchResults.classList.add('active');
            } else {
                searchResults.innerHTML = '<div class="search-result-item"><div class="search-result-info">No results found</div></div>';
                searchResults.classList.add('active');
            }
        } catch (error) {
            console.error('Search error:', error);
        }
    });

    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchBox.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.remove('active');
        }
    });

    // Keyboard shortcut for search
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            searchBox.focus();
        }
    });

    // Duplicate ticker content for seamless loop
    function setupTicker() {
        const ticker = document.getElementById('ticker-content');
        if (ticker) {
            const clone = ticker.innerHTML;
            ticker.innerHTML = clone + clone;
        }
    }

    // Real-time dashboard updates
    async function refreshDashboardData() {
        try {
            const response = await fetch('/api/dashboard-stats');
            const data = await response.json();
            
            // Update stat cards
            document.querySelector('.stat-card.branches .stat-number').textContent = data.total_branches;
            document.querySelector('.stat-card.staff .stat-number').textContent = data.total_staff;
            document.querySelector('.stat-card.present .stat-number').textContent = data.present_today;
            document.querySelector('.stat-card.late .stat-number').textContent = data.late_today;
            document.querySelector('.stat-card.absent .stat-number').textContent = data.absent_today;
            
            // Update first check-in
            const firstCheckinCard = document.getElementById('first-checkin-card');
            if (data.first_checkin && firstCheckinCard) {
                firstCheckinCard.querySelector('.name').textContent = data.first_checkin.name;
                firstCheckinCard.querySelector('.time').textContent = 
                    `Checked in at ${data.first_checkin.time} ¬∑ ${data.first_checkin.school}`;
            }
            
            // Update ticker if new activity
            if (data.recent_activity && data.recent_activity.length > 0) {
                const ticker = document.getElementById('ticker-content');
                const tickerHtml = data.recent_activity.map(a => `
                    <div class="ticker-item">
                        <span class="ticker-dot ${a.type}"></span>
                        <span>${a.name}</span>
                        <span class="ticker-time">${a.action} ${a.time}</span>
                    </div>
                `).join('');
                ticker.innerHTML = tickerHtml + tickerHtml;
            }
        } catch (error) {
            console.error('Failed to refresh dashboard:', error);
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        updateGreeting();
        updateClock();
        setInterval(updateClock, 1000);
        animateCounters();
        createSparklines();
        setupTicker();
        
        // Refresh dashboard every 15 seconds
        setInterval(refreshDashboardData, 15000);
    });
</script>
{% endblock %}
