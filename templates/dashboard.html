{% extends 'base.html' %}

{% block title %}Dashboard - Attendance System{% endblock %}

{% block content %}
<style>
    /* Clock Styles - Smooth, No Jitter */
    .clock-container {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    .analog-clock {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(145deg, #ffffff, #e6e6e6);
        box-shadow: 
            0 4px 15px rgba(0,0,0,0.1),
            inset 0 2px 4px rgba(255,255,255,0.9),
            inset 0 -2px 4px rgba(0,0,0,0.05);
        position: relative;
        border: 3px solid #f0f0f0;
    }
    .clock-face {
        width: 100%;
        height: 100%;
        position: relative;
    }
    .clock-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 8px;
        height: 8px;
        background: linear-gradient(145deg, #444, #222);
        border-radius: 50%;
        z-index: 10;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    .clock-center::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 4px;
        height: 4px;
        background: #dc3545;
        border-radius: 50%;
    }
    .hour-marks {
        position: absolute;
        width: 100%;
        height: 100%;
    }
    .hour-mark {
        position: absolute;
        width: 2px;
        height: 6px;
        background: #333;
        left: 50%;
        transform-origin: center 40px;
        border-radius: 1px;
    }
    .hour-mark.main {
        height: 8px;
        width: 2.5px;
        background: #222;
    }
    .brand-dot {
        position: absolute;
        top: 18px;
        left: 50%;
        transform: translateX(-50%);
        width: 4px;
        height: 4px;
        background: #dc3545;
        border-radius: 50%;
    }
    .hand {
        position: absolute;
        bottom: 50%;
        left: 50%;
        transform-origin: bottom center;
        border-radius: 2px;
    }
    .hour-hand {
        width: 3px;
        height: 22px;
        background: linear-gradient(to top, #222, #444);
        margin-left: -1.5px;
        z-index: 3;
    }
    .minute-hand {
        width: 2px;
        height: 30px;
        background: linear-gradient(to top, #333, #555);
        margin-left: -1px;
        z-index: 2;
    }
    .second-hand {
        width: 1px;
        height: 34px;
        background: #dc3545;
        margin-left: -0.5px;
        z-index: 4;
    }
    .second-hand::after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 3px;
        height: 10px;
        background: #dc3545;
        border-radius: 1px;
    }
    .digital-clock {
        text-align: left;
    }
    .digital-time {
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
        font-family: 'Segoe UI', system-ui, sans-serif;
        letter-spacing: 1px;
        line-height: 1.2;
    }
    .digital-time .seconds {
        font-size: 0.9rem;
        color: #dc3545;
        font-weight: 600;
    }
    .digital-time .ampm {
        font-size: 0.7rem;
        color: #666;
        margin-left: 3px;
        font-weight: 500;
    }
    .digital-date {
        font-size: 0.75rem;
        color: #888;
        margin-top: 2px;
    }

    /* Welcome Message */
    .welcome-text {
        font-size: 0.85rem;
        color: #666;
    }
    .welcome-text strong {
        color: #333;
    }

    /* Activity Ticker - Top Position */
    .ticker-section {
        margin-bottom: 1.5rem;
    }
    .ticker-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }
    .live-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .live-dot {
        width: 6px;
        height: 6px;
        background: #fff;
        border-radius: 50%;
        animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(0.8); }
    }
    .ticker-label {
        font-size: 0.75rem;
        color: #888;
    }
    .ticker-wrapper {
        background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
        border-radius: 10px;
        padding: 10px 0;
        position: relative;
        overflow: hidden;
        border: 1px solid #eee;
    }
    .ticker-wrapper::before,
    .ticker-wrapper::after {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        width: 40px;
        z-index: 2;
        pointer-events: none;
    }
    .ticker-wrapper::before {
        left: 0;
        background: linear-gradient(to right, #f8f9fa, transparent);
    }
    .ticker-wrapper::after {
        right: 0;
        background: linear-gradient(to left, #fff, transparent);
    }
    .ticker-track {
        display: flex;
        gap: 30px;
        animation: ticker 30s linear infinite;
        width: max-content;
    }
    .ticker-track:hover {
        animation-play-state: paused;
    }
    @keyframes ticker {
        0% { transform: translateX(0); }
        100% { transform: translateX(-50%); }
    }
    .ticker-item {
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
        font-size: 0.8rem;
        color: #555;
    }
    .ticker-item .check {
        color: #28a745;
        font-weight: bold;
    }
    .ticker-item .name {
        font-weight: 600;
        color: #333;
    }
    .ticker-item .time {
        color: #888;
        font-size: 0.75rem;
    }
    .ticker-item .branch {
        background: #e9ecef;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        color: #666;
    }

    /* Stat Cards */
    .stat-card {
        border: none;
        border-radius: 12px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .stat-card .card-body {
        padding: 1.25rem;
        position: relative;
        z-index: 2;
    }
    .stat-card .decorative-circle {
        position: absolute;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(255,255,255,0.1);
        top: -20px;
        right: -20px;
        z-index: 1;
    }
    .stat-card h3 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0;
    }
    .stat-card small {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.9;
    }
    .stat-card i.fa-2x {
        font-size: 1.5rem;
        opacity: 0.9;
    }
    .sparkline-container {
        height: 25px;
        margin-top: 8px;
        opacity: 0.7;
    }

    /* Branch Stats Table */
    .branch-table {
        border: none;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 15px rgba(0,0,0,0.05);
    }
    .branch-table .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
        border-bottom: 1px solid #eee;
        padding: 1rem 1.25rem;
        font-weight: 600;
    }
    .branch-table .table {
        margin: 0;
    }
    .branch-table .table th {
        border-top: none;
        font-weight: 600;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        padding: 0.75rem 1rem;
        background: #fafbfc;
    }
    .branch-table .table td {
        padding: 0.75rem 1rem;
        vertical-align: middle;
        border-color: #f3f3f3;
    }
    .branch-table .table tbody tr {
        transition: background 0.2s ease;
    }
    .branch-table .table tbody tr:hover {
        background: #f8f9fa;
    }
    .branch-table .badge {
        padding: 0.4em 0.8em;
        font-weight: 500;
    }
    .branch-table .progress {
        height: 8px;
        border-radius: 4px;
        background: #e9ecef;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h2 class="mb-1 fw-bold"><i class="fas fa-tachometer-alt me-2 text-primary"></i>Dashboard</h2>
        <p class="welcome-text mb-0">
            {% set hour = now().hour if now is defined else 12 %}
            {% if hour < 12 %}Good morning{% elif hour < 17 %}Good afternoon{% else %}Good evening{% endif %}, 
            <strong>{{ current_user.username }}</strong>
        </p>
    </div>
    <div class="clock-container">
        <div class="analog-clock">
            <div class="clock-face">
                <div class="brand-dot"></div>
                <div class="hour-marks">
                    {% for i in range(12) %}
                    <div class="hour-mark {% if i % 3 == 0 %}main{% endif %}" style="transform: translateX(-50%) rotate({{ i * 30 }}deg);"></div>
                    {% endfor %}
                </div>
                <div class="hand hour-hand" id="hourHand"></div>
                <div class="hand minute-hand" id="minuteHand"></div>
                <div class="hand second-hand" id="secondHand"></div>
                <div class="clock-center"></div>
            </div>
        </div>
        <div class="digital-clock">
            <div class="digital-time">
                <span id="digitalTime">12:00</span><span class="seconds" id="digitalSeconds">:00</span><span class="ampm" id="digitalAmpm">AM</span>
            </div>
            <div class="digital-date" id="digitalDate">Monday, January 1</div>
        </div>
    </div>
</div>

<!-- Live Activity Ticker - Now at Top -->
<div class="ticker-section">
    <div class="ticker-header">
        <span class="live-badge"><span class="live-dot"></span> Live</span>
        <span class="ticker-label">Recent Activity</span>
    </div>
    <div class="ticker-wrapper">
        <div class="ticker-track" id="tickerTrack">
            {% if recent_activity %}
                {% for activity in recent_activity %}
                <div class="ticker-item">
                    <span class="check">✓</span>
                    <span class="name">{{ activity.name }}</span>
                    <span class="time">{{ activity.time }}</span>
                    <span class="branch">{{ activity.branch }}</span>
                </div>
                {% endfor %}
                {% for activity in recent_activity %}
                <div class="ticker-item">
                    <span class="check">✓</span>
                    <span class="name">{{ activity.name }}</span>
                    <span class="time">{{ activity.time }}</span>
                    <span class="branch">{{ activity.branch }}</span>
                </div>
                {% endfor %}
            {% else %}
                <div class="ticker-item"><span class="check">✓</span><span class="name">System Ready</span><span class="time">Now</span></div>
                <div class="ticker-item"><span class="check">✓</span><span class="name">Awaiting Check-ins</span><span class="time">Today</span></div>
                <div class="ticker-item"><span class="check">✓</span><span class="name">System Ready</span><span class="time">Now</span></div>
                <div class="ticker-item"><span class="check">✓</span><span class="name">Awaiting Check-ins</span><span class="time">Today</span></div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4 g-3">
    <div class="col">
        <a href="{{ url_for('schools') }}" class="text-decoration-none">
            <div class="card stat-card stat-schools h-100">
                <div class="decorative-circle"></div>
                <div class="card-body text-center text-white">
                    <i class="fas fa-building fa-2x mb-2"></i>
                    <h3 class="counter" data-target="{{ total_schools }}">0</h3>
                    <small>Branches</small>
                    <div class="sparkline-container">
                        <canvas id="sparkBranches" height="25"></canvas>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col">
        <a href="{{ url_for('staff_list') }}" class="text-decoration-none">
            <div class="card stat-card stat-staff h-100">
                <div class="decorative-circle"></div>
                <div class="card-body text-center text-white">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <h3 class="counter" data-target="{{ total_staff }}">0</h3>
                    <small>Total Staff</small>
                    <div class="sparkline-container">
                        <canvas id="sparkStaff" height="25"></canvas>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col">
        <a href="{{ url_for('attendance_report', today=1) }}" class="text-decoration-none">
            <div class="card stat-card stat-present h-100">
                <div class="decorative-circle"></div>
                <div class="card-body text-center text-white">
                    <i class="fas fa-user-check fa-2x mb-2"></i>
                    <h3 class="counter" data-target="{{ today_attendance }}">0</h3>
                    <small>Present Today</small>
                    <div class="sparkline-container">
                        <canvas id="sparkPresent" height="25"></canvas>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col">
        <a href="{{ url_for('late_report', today=1) }}" class="text-decoration-none">
            <div class="card stat-card stat-late h-100">
                <div class="decorative-circle"></div>
                <div class="card-body text-center text-white">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h3 class="counter" data-target="{{ late_today }}">0</h3>
                    <small>Late Today</small>
                    <div class="sparkline-container">
                        <canvas id="sparkLate" height="25"></canvas>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col">
        <a href="{{ url_for('absent_report', today=1) }}" class="text-decoration-none">
            <div class="card stat-card stat-absent h-100">
                <div class="decorative-circle"></div>
                <div class="card-body text-center text-white">
                    <i class="fas fa-user-times fa-2x mb-2"></i>
                    <h3 class="counter" data-target="{{ absent_today }}">0</h3>
                    <small>Absent Today</small>
                    <div class="sparkline-container">
                        <canvas id="sparkAbsent" height="25"></canvas>
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Branch Statistics Table -->
{% if school_stats %}
<div class="card branch-table">
    <div class="card-header">
        <i class="fas fa-chart-bar me-2 text-primary"></i>Branch Statistics (Today)
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Branch</th>
                        <th>Total Staff</th>
                        <th>Present</th>
                        <th>Late</th>
                        <th>Attendance Rate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in school_stats %}
                    <tr>
                        <td>
                            <strong>{{ stat.school.name }}</strong>
                            {% if stat.school.short_name %}
                            <br><small class="text-muted">{{ stat.school.short_name }}</small>
                            {% endif %}
                        </td>
                        <td>{{ stat.total_staff }}</td>
                        <td><span class="badge bg-success">{{ stat.present }}</span></td>
                        <td><span class="badge bg-warning text-dark">{{ stat.late }}</span></td>
                        <td style="min-width: 150px;">
                            {% if stat.total_staff > 0 %}
                            {% set rate = (stat.present / stat.total_staff * 100)|round(1) %}
                            <div class="d-flex align-items-center gap-2">
                                <div class="progress flex-grow-1">
                                    <div class="progress-bar {% if rate >= 80 %}bg-success{% elif rate >= 50 %}bg-warning{% else %}bg-danger{% endif %}" style="width: {{ rate }}%"></div>
                                </div>
                                <small class="text-muted" style="width: 40px;">{{ rate }}%</small>
                            </div>
                            {% else %}
                            <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Stable Clock - No Jitter
function updateClock() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const seconds = now.getSeconds();
    
    const hourDeg = (hours % 12) * 30 + minutes * 0.5;
    const minuteDeg = minutes * 6 + seconds * 0.1;
    const secondDeg = seconds * 6;
    
    document.getElementById('hourHand').style.transform = `translateX(-50%) rotate(${hourDeg}deg)`;
    document.getElementById('minuteHand').style.transform = `translateX(-50%) rotate(${minuteDeg}deg)`;
    document.getElementById('secondHand').style.transform = `translateX(-50%) rotate(${secondDeg}deg)`;
    
    const h = hours % 12 || 12;
    const m = minutes.toString().padStart(2, '0');
    const s = seconds.toString().padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    
    document.getElementById('digitalTime').textContent = `${h}:${m}`;
    document.getElementById('digitalSeconds').textContent = `:${s}`;
    document.getElementById('digitalAmpm').textContent = ampm;
    
    const options = { weekday: 'long', month: 'long', day: 'numeric' };
    document.getElementById('digitalDate').textContent = now.toLocaleDateString('en-US', options);
}
updateClock();
setInterval(updateClock, 1000);

// Animated Counters (2 second duration)
document.querySelectorAll('.counter').forEach(counter => {
    const target = parseInt(counter.dataset.target) || 0;
    const duration = 2000;
    const startTime = performance.now();
    
    function animate(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3);
        counter.textContent = Math.floor(target * eased);
        if (progress < 1) requestAnimationFrame(animate);
        else counter.textContent = target;
    }
    requestAnimationFrame(animate);
});

// Sparklines
function createSparkline(canvasId) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    const data = Array.from({length: 7}, () => Math.floor(Math.random() * 40) + 60);
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['', '', '', '', '', '', ''],
            datasets: [{
                data: data,
                borderColor: 'rgba(255,255,255,0.8)',
                borderWidth: 1.5,
                fill: true,
                backgroundColor: 'rgba(255,255,255,0.2)',
                tension: 0.4,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { display: false }, y: { display: false } }
        }
    });
}
createSparkline('sparkBranches');
createSparkline('sparkStaff');
createSparkline('sparkPresent');
createSparkline('sparkLate');
createSparkline('sparkAbsent');
</script>
{% endblock %}
